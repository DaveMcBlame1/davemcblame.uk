<!DOCTYPE html>
<html lang="en">
<head>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
  <link rel="stylesheet" href="../css/bsdefault.css">
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Purchase A Page - Multigrounds</title>
</head>
<body class="PP">
  <header class="header">
    <a href="/"> <img src="../Multigrounds.png" alt="Logo" class="logo"/></a>
    <div class="top-links">
      <a href="/pages/billing">Get Started</a>
      <a href="/pages/my-pages">My Pages</a>
    </div>
  </header>
  
  <main class="container py-5">
    <div class="row justify-content-center">
      <div class="col-lg-10">
        <div class="text-center mb-5">
          <h1>Create Your Professional Web Presence</h1>
          <p class="lead">Choose the perfect plan for your portfolio, business, or personal brand</p>
          <p class="text-muted">Please make a ticket including the name of the page and plan you choose including any other extras you would like. If no ticket is made, your account and page will be locked until payment is received within 24 hours.</p>
        </div>
        
        <div class="row g-4">
          <!-- Solo Plan -->
          <div class="col-lg-3 col-md-6">
            <div class="card plan-card h-100" data-plan="solo">
              <div class="card-body text-center">
                <h4>Solo</h4>
                <div class="price-breakdown">
                  <div class="h5 text-primary mb-1">$8 <small class="text-muted">setup</small></div>
                  <div class="h5 text-success">$4<small class="text-muted">/month</small></div>
                </div>
                <p class="text-muted">Perfect for a single-page portfolio</p>
                <ul class="list-unstyled text-start">
                  <li>✅ <strong>1 Page</strong></li>
                  <li>✅ Drag & drop builder</li>
                  <li>✅ Mobile responsive</li>
                  <li>✅ SSL certificate</li>
                  <li>✅ Basic support</li>
                </ul>
                <button class="btn btn-outline-primary btn-lg w-100" onclick="selectPlan('solo', 8, 4)">
                  Choose Solo
                </button>
              </div>
            </div>
          </div>
          
          <!-- Starter Plan -->
          <div class="col-lg-3 col-md-6">
            <div class="card plan-card h-100" data-plan="starter">
              <div class="card-body text-center">
                <h4>Starter</h4>
                <div class="price-breakdown">
                  <div class="h5 text-primary mb-1">$16 <small class="text-muted">setup</small></div>
                  <div class="h5 text-success">$8<small class="text-muted">/month</small></div>
                </div>
                <p class="text-muted">Good for small projects or teachers</p>
                <ul class="list-unstyled text-start">
                  <li>✅ <strong>3 Pages</strong></li>
                  <li>✅ Everything in Solo</li>
                  <li>✅ Custom CSS support</li>
                  <li>✅ Priority support</li>
                  <li>✅ Analytics dashboard</li>
                </ul>
                <button class="btn btn-outline-primary btn-lg w-100" onclick="selectPlan('starter', 16, 8)">
                  Choose Starter
                </button>
              </div>
            </div>
          </div>
          
          <!-- Expansive Plan -->
          <div class="col-lg-3 col-md-6">
            <div class="card plan-card h-100 border-warning position-relative" data-plan="expansive">
              <span class="badge bg-warning popular-badge">Popular</span>
              <div class="card-body text-center">
                <h4>Expansive</h4>
                <div class="price-breakdown">
                  <div class="h5 text-primary mb-1">$32 <small class="text-muted">setup</small></div>
                  <div class="h5 text-success">$16<small class="text-muted">/month</small></div>
                </div>
                <p class="text-muted">For bigger portfolios with more content</p>
                <ul class="list-unstyled text-start">
                  <li>✅ <strong>8 Pages</strong></li>
                  <li>✅ Everything in Starter</li>
                  <li>✅ Advanced blocks</li>
                  <li>✅ SEO optimization</li>
                  <li>✅ Contact forms</li>
                </ul>
                <button class="btn btn-warning btn-lg w-100" onclick="selectPlan('expansive', 32, 16)">
                  Choose Expansive
                </button>
              </div>
            </div>
          </div>
          
          <!-- Business Plan -->
          <div class="col-lg-3 col-md-6">
            <div class="card plan-card h-100 border-dark" data-plan="business">
              <div class="card-body text-center">
                <h4>Business</h4>
                <div class="price-breakdown">
                  <div class="h5 text-primary mb-1">$64 <small class="text-muted">setup</small></div>
                  <div class="h5 text-success">$32<small class="text-muted">/month</small></div>
                </div>
                <p class="text-muted">Full portfolio + hosting support</p>
                <ul class="list-unstyled text-start">
                  <li>✅ <strong>15 Pages</strong></li>
                  <li>✅ Everything in Expansive</li>
                  <li>✅ White-label branding</li>
                  <li>✅ 24/7 priority support</li>
                  <li>✅ Custom domain support</li>
                </ul>
                <button class="btn btn-dark btn-lg w-100" onclick="selectPlan('business', 64, 32)">
                  Choose Business
                </button>
              </div>
            </div>
          </div>
        </div>
        
        <!-- Extras Section -->
        <div class="card mt-5">
          <div class="card-body">
            <h3 class="text-center mb-4">Add-On Features</h3>
            <div class="row text-center">
              <div class="col-md-4">
                <div class="p-3">
                  <i class="fas fa-code fa-3x text-primary mb-3"></i>
                  <h5>Interactive JavaScript</h5>
                  <p class="text-muted">Add custom interactive elements to your pages</p>
                  <div class="h4 text-success">+$5<small class="text-muted"> each</small></div>
                </div>
              </div>
              <div class="col-md-4">
                <div class="p-3">
                  <i class="fas fa-external-link-alt fa-3x text-info mb-3"></i>
                  <h5>External API Integration</h5>
                  <p class="text-muted">Connect to third-party services and APIs</p>
                  <div class="h4 text-success">+$10<small class="text-muted"> each</small></div>
                </div>
              </div>
              <div class="col-md-4">
                <div class="p-3">
                  <i class="fas fa-database fa-3x text-warning mb-3"></i>
                  <h5>Database Integration</h5>
                  <p class="text-muted">Store and manage dynamic content</p>
                  <div class="h4 text-success">+$15<small class="text-muted"> each</small></div>
                </div>
              </div>
            </div>
          </div>
        </div>
        
        <!-- How It Works -->
        <div class="text-center mt-5">
          <h3>How It Works</h3>
          <div class="row mt-4">
            <div class="col-md-3">
              <div class="text-primary mb-3">
                <i class="fas fa-shopping-cart fa-3x"></i>
              </div>
              <h5>1. Choose Plan</h5>
              <p>Select the perfect plan for your needs</p>
            </div>
            <div class="col-md-3">
              <div class="text-primary mb-3">
                <i class="fas fa-credit-card fa-3x"></i>
              </div>
              <h5>2. Pay Setup Fee</h5>
              <p>One-time setup fee to get started</p>
            </div>
            <div class="col-md-3">
              <div class="text-primary mb-3">
                <i class="fas fa-edit fa-3x"></i>
              </div>
              <h5>3. Build & Design</h5>
              <p>Use our drag & drop builder</p>
            </div>
            <div class="col-md-3">
              <div class="text-primary mb-3">
                <i class="fas fa-globe fa-3x"></i>
              </div>
              <h5>4. Go Live</h5>
              <p>Your pages are published instantly</p>
            </div>
          </div>
        </div>
        
        <!-- FAQ Section -->
        <div class="mt-5">
          <h3 class="text-center mb-4">Frequently Asked Questions</h3>
          <div class="row">
            <div class="col-md-6">
              <div class="card mb-3">
                <div class="card-body">
                  <h6>Can I upgrade my plan later?</h6>
                  <p class="text-muted mb-0">Yes! You can upgrade to any higher plan at any time. You'll only pay the difference.</p>
                </div>
              </div>
            </div>
            <div class="col-md-6">
              <div class="card mb-3">
                <div class="card-body">
                  <h6>What happens if I cancel?</h6>
                  <p class="text-muted mb-0">Your pages remain active until the end of your billing period, then they're archived.</p>
                </div>
              </div>
            </div>
            <div class="col-md-6">
              <div class="card mb-3">
                <div class="card-body">
                  <h6>Do I need coding knowledge?</h6>
                  <p class="text-muted mb-0">Not at all! Our drag-and-drop builder is designed for everyone, no coding required.</p>
                </div>
              </div>
            </div>
            <div class="col-md-6">
              <div class="card mb-3">
                <div class="card-body">
                  <h6>Can I use my own domain?</h6>
                  <p class="text-muted mb-0">Business plan includes custom domain support. Other plans use multigrounds.org/yourname</p>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </main>

  <!-- Plan Selection Modal -->
  <div class="modal fade" id="planModal">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">Complete Your Purchase</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
          <div class="text-center mb-4">
            <h4 id="selected-plan-name">Solo Plan</h4>
            <div class="price-breakdown">
              <div class="h5 text-primary">Setup: $<span id="setup-cost">8</span></div>
              <div class="h5 text-success">Monthly: $<span id="monthly-cost">4</span></div>
            </div>
          </div>
          
          <div id="login-required" style="display: none;">
            <div class="alert alert-info">
              <i class="fas fa-info-circle"></i> You need to log in or create an account to purchase a plan.
            </div>
            <div class="text-center">
              <a href="/pages/support" class="btn btn-primary">Login / Register</a>
            </div>
          </div>
          
          <div id="purchase-form">
            <form id="checkout-form">
              <div class="mb-3">
                <label class="form-label">Preferred Subdomain</label>
                <div class="input-group">
                  <span class="input-group-text">multigrounds.org/sites/</span>
                  <input type="text" id="subdomain-input" class="form-control" placeholder="yourname" required>
                </div>
                <small class="text-muted">Choose your unique web address</small>
              </div>
              
              <div class="mb-3">
                <div class="form-check">
                  <input type="checkbox" class="form-check-input" id="terms-check" required>
                  <label class="form-check-label" for="terms-check">
                    I agree to the <a href="/pages/terms" target="_blank">Terms of Service</a>
                  </label>
                </div>
              </div>
            </form>
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
          <button type="button" class="btn btn-success" onclick="proceedToPayment()">
            <i class="fas fa-credit-card"></i> Proceed to Payment
          </button>
        </div>
      </div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
  <script>
const API_BASE = 'https://api.multigrounds.org/api';
let currentUser = null;
let selectedPlan = null;

// Plan data - Updated to match your HTML
const plans = {
    solo: {
        name: 'solo',
        setupCost: 8,
        monthlyCost: 4,
        features: ['1 Page', 'Basic Support', 'SSL Certificate']
    },
    starter: {
        name: 'starter',
        setupCost: 16,
        monthlyCost: 8,
        features: ['3 Pages', 'Custom CSS', 'Priority Support', 'Analytics']
    },
    expansive: {
        name: 'expansive',
        setupCost: 32,
        monthlyCost: 16,
        features: ['8 Pages', 'Advanced blocks', 'SEO optimization', 'Contact forms']
    },
    business: {
        name: 'business', 
        setupCost: 64,
        monthlyCost: 32,
        features: ['15 Pages', 'White-label branding', '24/7 Support', 'Custom Domain']
    }
};

// Check login status when page loads
document.addEventListener('DOMContentLoaded', async () => {
    await checkLoginStatus();
});

async function checkLoginStatus() {
    try {
        const response = await fetch(`${API_BASE}/check-login`, {
            credentials: 'include'
        });
        const data = await response.json();
        
        if (data.success && data.logged_in) {
            currentUser = data.user;
            showLoggedInState();
        } else {
            showLoggedOutState();
        }
    } catch (error) {
        console.error('Error checking login status:', error);
        showLoggedOutState();
    }
}

function showLoggedInState() {
    // Add a user info section to show they're logged in
    const userInfo = document.createElement('div');
    userInfo.id = 'user-info';
    userInfo.className = 'alert alert-success mb-4';
    userInfo.innerHTML = `
        <div class="d-flex justify-content-between align-items-center">
            <div>
                <strong>✅ Logged in as: ${currentUser.username}</strong>
                <br><small>Email: ${currentUser.email}</small>
            </div>
            <button onclick="logout()" class="btn btn-outline-secondary btn-sm">Logout</button>
        </div>
    `;
    
    // Insert at the top of the main content
    const mainContent = document.querySelector('main .container');
    if (mainContent && !document.getElementById('user-info')) {
        mainContent.insertBefore(userInfo, mainContent.firstChild);
    }
}

function showLoggedOutState() {
    // Show login prompt
    const loginPrompt = document.createElement('div');
    loginPrompt.id = 'login-prompt';
    loginPrompt.className = 'alert alert-warning mb-4';
    loginPrompt.innerHTML = `
        <strong>⚠️ Please log in first</strong>
        <p class="mb-2">You need to be logged in to create a page.</p>
        <a href="/pages/support" class="btn btn-primary btn-sm">Login / Register</a>
    `;
    
    const mainContent = document.querySelector('main .container');
    if (mainContent && !document.getElementById('login-prompt')) {
        mainContent.insertBefore(loginPrompt, mainContent.firstChild);
    }
    
    // Disable the plan cards
    document.querySelectorAll('.plan-card').forEach(card => {
        card.style.opacity = '0.6';
        card.style.pointerEvents = 'none';
    });
}

// This function handles the onclick from your HTML buttons
function selectPlan(planName, setupCost, monthlyCost) {
    if (!currentUser) {
        alert('Please log in first before selecting a plan.');
        window.location.href = '/pages/support';
        return;
    }
    
    // Set the selected plan data
    selectedPlan = {
        name: planName,
        setupCost: setupCost,
        monthlyCost: monthlyCost
    };
    
    // Update the modal with plan details
    document.getElementById('selected-plan-name').textContent = planName.toUpperCase() + ' Plan';
    document.getElementById('setup-cost').textContent = setupCost;
    document.getElementById('monthly-cost').textContent = monthlyCost;
    
    // Check login status in modal
    if (currentUser) {
        document.getElementById('login-required').style.display = 'none';
        document.getElementById('purchase-form').style.display = 'block';
    } else {
        document.getElementById('login-required').style.display = 'block';
        document.getElementById('purchase-form').style.display = 'none';
    }
    
    // Show the modal
    const modal = new bootstrap.Modal(document.getElementById('planModal'));
    modal.show();
}

async function proceedToPayment() {
    // Check if user is logged in first
    if (!currentUser) {
        alert('Please log in first before creating a page.');
        window.location.href = '/pages/support';
        return;
    }
    
    if (!selectedPlan) {
        alert('Please select a plan first.');
        return;
    }
    
    const subdomain = document.getElementById('subdomain-input').value.trim().toLowerCase();
    const termsChecked = document.getElementById('terms-check').checked;
    
    if (!subdomain) {
        alert('Please enter a subdomain');
        return;
    }
    
    if (!termsChecked) {
        alert('Please accept the Terms of Service');
        return;
    }
    
    // Validate subdomain format
    if (!/^[a-z0-9-]+$/.test(subdomain) || subdomain.length < 3) {
        alert('Subdomain must be at least 3 characters and contain only letters, numbers, and hyphens');
        return;
    }
    
    // Check if subdomain is available first
    try {
        const checkResponse = await fetch(`${API_BASE}/check-subdomain/${subdomain}`, {
            credentials: 'include'
        });
        const checkData = await checkResponse.json();
        
        if (!checkData.available) {
            alert('This subdomain is already taken. Please choose another one.');
            return;
        }
    } catch (error) {
        console.error('Error checking subdomain:', error);
        alert('Error checking subdomain availability. Please try again.');
        return;
    }
    
    // Show loading state - find the button properly
    const btn = document.querySelector('#planModal .btn-success') || 
               document.querySelector('[onclick="proceedToPayment()"]');
    
    let originalText = 'Proceed to Payment';
    if (btn) {
        originalText = btn.innerHTML;
        btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Creating...';
        btn.disabled = true;
    }
    
    // Create the purchase
    try {
        const response = await fetch(`${API_BASE}/create-purchase`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            credentials: 'include',
            body: JSON.stringify({
                subdomain: subdomain,
                plan: selectedPlan.name,
                setupCost: selectedPlan.setupCost,
                monthlyCost: selectedPlan.monthlyCost,
                title: `${subdomain}'s Page`
            })
        });
        
        const data = await response.json();
        if (data.success) {
            alert(`Success! Your site "${subdomain}" has been created.\n\nYou can view it at: https://multigrounds.org/sites/${subdomain}\nOr edit it using the page builder.`);
            
            // Close modal and redirect
            const modal = bootstrap.Modal.getInstance(document.getElementById('planModal'));
            if (modal) {
                modal.hide();
            }
            
            // Give user choice
            const goToBuilder = confirm('Would you like to start building your site now?\n\nClick OK to go to Page Builder\nClick Cancel to stay here');
            if (goToBuilder) {
                window.location.href = `/pages/builder.html?page=${subdomain}`;
            } else {
                // Refresh the page to show updated state
                window.location.reload();
            }
        } else {
            alert('Error: ' + data.message);
        }
    } catch (error) {
        console.error('Purchase error:', error);
        alert('Error processing purchase. Please try again.');
    } finally {
        // Restore button state
        if (btn) {
            btn.innerHTML = originalText;
            btn.disabled = false;
        }
    }
}

async function logout() {
    try {
        const response = await fetch(`${API_BASE}/logout`, {
            method: 'POST',
            credentials: 'include'
        });
        
        if (response.ok) {
            currentUser = null;
            document.getElementById('user-info')?.remove();
            showLoggedOutState();
            alert('You have been logged out.');
        }
    } catch (error) {
        console.error('Logout error:', error);
    }
}
  </script>
  
  <footer class="footer">
    <div class="container">
      <div class="row">
        <!-- Main Footer Content -->
        <div class="col-md align-self-center">
          <div class="row">
            <div class="col-6 col-md-auto mr-md-3 mt-1">
              <h6 class="text-bold-600">Company</h6>
              <ul>
                <li><a href="/pages/about">About Us</a></li>
                <li><a href="/pages/billing">Pricing</a></li>
              </ul>
            </div>
            
            <div class="col-6 col-md-auto mr-md-3 mt-1">
              <h6 class="text-bold-600">Resources</h6>
              <ul>
                <li><a href="/pages/support">Support</a></li>
              </ul>
            </div>
            
            <div class="col-6 col-md-auto mr-md-3 mt-1">
              <h6 class="text-bold-600">Legal</h6>
              <ul>
                <li><a href="/pages/policy">Privacy Policy</a></li>
                <li><a href="/pages/terms">Terms of Service</a></li>
              </ul>
            </div>
            
            <div class="col-6 col-md-auto mr-md-3 mt-1">
              <h6 class="text-bold-600">Contact</h6>
              <ul>
                <li><a href="mailto:davemcblame@multigrounds.org">Email Us</a></li>
              </ul>
            </div>
          </div>
        </div>
        
        <!-- Copyright Section -->
        <div class="col-md-auto text-center text-md-right mt-2 mt-md-2">
          <p class="mb-0">
            © 2025 Multigrounds<br>
            <span class="text-muted d-none d-md-inline mt-1">Made in US MO</span>
          </p>
        </div>
      </div>
    </div>
  </footer>
</body>
</html>
