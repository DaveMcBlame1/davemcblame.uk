<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Page Builder - Multigrounds</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        .builder-sidebar {
            background: #f8f9fa;
            min-height: 100vh;
            border-right: 1px solid #dee2e6;
        }
        
        .block-item {
            cursor: grab;
            transition: transform 0.2s;
        }
        
        .block-item:hover {
            transform: translateY(-2px);
        }
        
        .preview-area {
            min-height: 100vh;
            background: white;
        }
        
        .editable-block {
            border: 2px dashed transparent;
            position: relative;
            transition: border-color 0.2s;
        }
        
        .editable-block:hover {
            border-color: #007bff;
        }
        
        .block-controls {
            position: absolute;
            top: -10px;
            right: -10px;
            opacity: 0;
            transition: opacity 0.2s;
        }
        
        .editable-block:hover .block-controls {
            opacity: 1;
        }
        
        .drop-zone {
            min-height: 50px;
            border: 2px dashed #ccc;
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 10px 0;
            transition: border-color 0.2s;
        }
        
        .drop-zone.drag-over {
            border-color: #007bff;
            background-color: rgba(0, 123, 255, 0.1);
        }
    </style>
</head>
<body>
    <div class="container-fluid">
        <div class="row">
            <!-- Sidebar -->
            <div class="col-md-3 builder-sidebar p-4">
                <div class="d-flex justify-content-between align-items-center mb-4">
                    <h4>Page Builder</h4>
                    <button class="btn btn-success btn-sm" onclick="savePage()">
                        <i class="fas fa-save"></i> Save
                    </button>
                </div>
                
                <!-- Page Settings -->
                <div class="card mb-4">
                    <div class="card-body">
                        <h6>Page Settings</h6>
                        <div class="mb-3">
                            <label class="form-label">Page Title</label>
                            <input type="text" id="page-title" class="form-control" placeholder="My Awesome Page">
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Subdomain</label>
                            <div class="input-group">
                                <input type="text" id="page-subdomain" class="form-control" placeholder="mypage">
                                <span class="input-group-text">.multigrounds.org</span>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Building Blocks -->
                <div class="card">
                    <div class="card-body">
                        <h6>Drag & Drop Blocks</h6>
                        
                        <div class="block-item card mb-2" draggable="true" data-block-type="header">
                            <div class="card-body py-2">
                                <i class="fas fa-heading text-primary"></i> Header
                            </div>
                        </div>
                        
                        <div class="block-item card mb-2" draggable="true" data-block-type="text">
                            <div class="card-body py-2">
                                <i class="fas fa-paragraph text-success"></i> Text
                            </div>
                        </div>
                        
                        <div class="block-item card mb-2" draggable="true" data-block-type="image">
                            <div class="card-body py-2">
                                <i class="fas fa-image text-warning"></i> Image
                            </div>
                        </div>
                        
                        <div class="block-item card mb-2" draggable="true" data-block-type="button">
                            <div class="card-body py-2">
                                <i class="fas fa-mouse-pointer text-info"></i> Button
                            </div>
                        </div>
                        
                        <div class="block-item card mb-2" draggable="true" data-block-type="spacer">
                            <div class="card-body py-2">
                                <i class="fas fa-arrows-alt-v text-secondary"></i> Spacer
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Preview Area -->
            <div class="col-md-9 preview-area p-0">
                <div class="bg-light p-3 border-bottom">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <span class="badge bg-primary">Preview Mode</span>
                            <span id="page-url" class="ms-2 text-muted">multigrounds.org/yourpage</span>
                        </div>
                        <div>
                            <button class="btn btn-outline-primary btn-sm" onclick="previewPage()">
                                <i class="fas fa-eye"></i> Preview
                            </button>
                            <button class="btn btn-primary btn-sm" onclick="publishPage()">
                                <i class="fas fa-globe"></i> Publish
                            </button>
                        </div>
                    </div>
                </div>
                
                <div id="canvas" class="p-4">
                    <div class="drop-zone">
                        <span class="text-muted">Drag blocks here to start building your page</span>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Block Editor Modal -->
    <div class="modal fade" id="blockEditorModal">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Edit Block</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body" id="block-editor-content">
                    <!-- Dynamic content based on block type -->
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-primary" onclick="saveBlockChanges()">Save Changes</button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="builder.js"></script>
    <script>
const API_BASE = 'https://api.multigrounds.org:10065/api';
let currentUser = null;
let currentPage = null;
let currentSubdomain = null;

document.addEventListener('DOMContentLoaded', async () => {
    console.log('Builder loaded, initializing...');
    
    // First check if user is logged in
    try {
        const response = await fetch(`${API_BASE}/check-login`, {
            credentials: 'include'
        });
        const data = await response.json();
        
        if (!data.success || !data.logged_in) {
            alert('Please log in first to use the page builder.');
            window.location.href = '/pages/support';
            return;
        }
        
        currentUser = data.user;
        console.log('User logged in:', currentUser.username);
        
        // Get page parameter from URL
        const urlParams = new URLSearchParams(window.location.search);
        const pageSubdomain = urlParams.get('page');
        
        if (pageSubdomain) {
            console.log('Loading page:', pageSubdomain);
            await loadPageForEditing(pageSubdomain);
        } else {
            console.log('No page parameter found, showing default state');
            showPageSelector();
        }
        
    } catch (error) {
        console.error('Error checking login:', error);
        alert('Error checking login status. Please try again.');
        window.location.href = '/pages/support';
    }
});

async function loadPageForEditing(subdomain) {
    try {
        const response = await fetch(`${API_BASE}/page/${subdomain}`, {
            credentials: 'include'
        });
        const data = await response.json();
        
        if (data.success) {
            if (!data.page.is_owner) {
                alert('You can only edit pages that you own.');
                window.location.href = '/pages/billing';
                return;
            }
            
            currentPage = data.page;
            currentSubdomain = subdomain;
            
            console.log('Page loaded successfully:', data.page);
            
            // Update the page info display
            updatePageDisplay(data.page);
            
            // Load the page data into the builder
            if (data.page.page_data) {
                const pageData = JSON.parse(data.page.page_data);
                if (pageData.blocks && pageData.blocks.length > 0) {
                    loadBlocksIntoBuilder(pageData.blocks);
                } else {
                    showEmptyBuilder();
                }
            } else {
                showEmptyBuilder();
            }
            
            // Load custom CSS if it exists
            if (data.page.custom_css) {
                loadCustomCSS(data.page.custom_css);
            }
            
        } else {
            console.error('Failed to load page:', data.message);
            alert('Failed to load page: ' + data.message);
            window.location.href = '/pages/billing';
        }
    } catch (error) {
        console.error('Error loading page:', error);
        alert('Error loading page. Please try again.');
        window.location.href = '/pages/billing';
    }
}

function updatePageDisplay(page) {
    // Update page title in the builder
    const titleElement = document.getElementById('page-title') || 
                        document.querySelector('.page-title') ||
                        document.querySelector('h1');
    
    if (titleElement) {
        if (titleElement.tagName === 'INPUT' || titleElement.tagName === 'TEXTAREA') {
            titleElement.value = page.title;
        } else {
            titleElement.textContent = `Editing: ${page.title}`;
        }
    }
    
    // Update subdomain display
    const subdomainElement = document.getElementById('page-subdomain') || 
                            document.querySelector('.page-subdomain') ||
                            document.querySelector('input[placeholder*="yourname"]');
    
    if (subdomainElement) {
        subdomainElement.value = page.subdomain;
        subdomainElement.placeholder = page.subdomain;
        subdomainElement.disabled = true; // Can't change subdomain after creation
    }
    
    // Show page URL
    const urlElement = document.getElementById('page-url') || 
                      document.querySelector('.page-url');
    
    if (urlElement) {
        urlElement.innerHTML = `<a href="https://api.multigrounds.org/pages/${page.subdomain}" target="_blank">
            View Page: https://api.multigrounds.org/pages/${page.subdomain}
        </a>`;
    }
    
    // Add page info if no specific elements found
    if (!titleElement && !subdomainElement) {
        const builderHeader = document.querySelector('.builder-header') || 
                             document.querySelector('header') ||
                             document.body.firstElementChild;
        
        if (builderHeader) {
            const pageInfo = document.createElement('div');
            pageInfo.className = 'page-info alert alert-info';
            pageInfo.innerHTML = `
                <h4>Editing: ${page.title}</h4>
                <p><strong>Subdomain:</strong> ${page.subdomain}</p>
                <p><strong>Page URL:</strong> <a href="https://api.multigrounds.org/pages/${page.subdomain}" target="_blank">
                    https://api.multigrounds.org/pages/${page.subdomain}
                </a></p>
            `;
            builderHeader.appendChild(pageInfo);
        }
    }
}

function loadBlocksIntoBuilder(blocks) {
    console.log('Loading blocks into builder:', blocks);
    
    // This depends on your specific builder implementation
    // Try different common methods to load blocks
    
    if (window.loadBlocks && typeof window.loadBlocks === 'function') {
        window.loadBlocks(blocks);
    } else if (window.pageBuilder && window.pageBuilder.loadBlocks) {
        window.pageBuilder.loadBlocks(blocks);
    } else if (window.builder && window.builder.loadBlocks) {
        window.builder.loadBlocks(blocks);
    } else {
        // Generic block loading - adapt this to your builder
        const builderContainer = document.getElementById('builder-container') || 
                                document.querySelector('.builder-content') ||
                                document.querySelector('.page-builder');
        
        if (builderContainer) {
            // Clear existing content
            builderContainer.innerHTML = '';
            
            // Add each block
            blocks.forEach((block, index) => {
                const blockElement = createBlockElement(block, index);
                builderContainer.appendChild(blockElement);
            });
        }
    }
}

function createBlockElement(block, index) {
    const blockDiv = document.createElement('div');
    blockDiv.className = `builder-block block-${block.type}`;
    blockDiv.dataset.blockIndex = index;
    blockDiv.dataset.blockType = block.type;
    
    const content = block.content || {};
    
    switch (block.type) {
        case 'header':
            blockDiv.innerHTML = `
                <div class="block-controls">
                    <span class="block-type">Header ${content.level || 1}</span>
                    <button onclick="editBlock(${index})" class="btn btn-sm btn-primary">Edit</button>
                    <button onclick="deleteBlock(${index})" class="btn btn-sm btn-danger">Delete</button>
                </div>
                <h${content.level || 1} class="text-${content.align || 'left'}">${content.text || 'Header'}</h${content.level || 1}>
            `;
            break;
            
        case 'text':
            blockDiv.innerHTML = `
                <div class="block-controls">
                    <span class="block-type">Text</span>
                    <button onclick="editBlock(${index})" class="btn btn-sm btn-primary">Edit</button>
                    <button onclick="deleteBlock(${index})" class="btn btn-sm btn-danger">Delete</button>
                </div>
                <p class="text-${content.align || 'left'}">${content.text || 'Text content'}</p>
            `;
            break;
            
        case 'image':
            blockDiv.innerHTML = `
                <div class="block-controls">
                    <span class="block-type">Image</span>
                    <button onclick="editBlock(${index})" class="btn btn-sm btn-primary">Edit</button>
                    <button onclick="deleteBlock(${index})" class="btn btn-sm btn-danger">Delete</button>
                </div>
                <div class="text-${content.align || 'center'}">
                    <img src="${content.src || ''}" alt="${content.alt || ''}" class="img-fluid" style="max-width: ${content.maxWidth || '100%'}">
                </div>
            `;
            break;
            
        case 'button':
            blockDiv.innerHTML = `
                <div class="block-controls">
                    <span class="block-type">Button</span>
                    <button onclick="editBlock(${index})" class="btn btn-sm btn-primary">Edit</button>
                    <button onclick="deleteBlock(${index})" class="btn btn-sm btn-danger">Delete</button>
                </div>
                <div class="text-${content.align || 'center'}">
                    <a href="${content.link || '#'}" class="btn btn-${content.style || 'primary'}">${content.text || 'Button'}</a>
                </div>
            `;
            break;
            
        case 'spacer':
            blockDiv.innerHTML = `
                <div class="block-controls">
                    <span class="block-type">Spacer</span>
                    <button onclick="editBlock(${index})" class="btn btn-sm btn-primary">Edit</button>
                    <button onclick="deleteBlock(${index})" class="btn btn-sm btn-danger">Delete</button>
                </div>
                <div style="height: ${content.height || '50px'}; background: #f0f0f0; border: 1px dashed #ccc;"></div>
            `;
            break;
            
        default:
            blockDiv.innerHTML = `
                <div class="block-controls">
                    <span class="block-type">Unknown Block</span>
                    <button onclick="deleteBlock(${index})" class="btn btn-sm btn-danger">Delete</button>
                </div>
                <p>Unknown block type: ${block.type}</p>
            `;
    }
    
    return blockDiv;
}

function loadCustomCSS(css) {
    const cssTextarea = document.getElementById('custom-css') || 
                       document.querySelector('textarea[placeholder*="css"]') ||
                       document.querySelector('.css-editor');
    
    if (cssTextarea) {
        cssTextarea.value = css;
    }
    
    // Apply CSS to preview if available
    let styleElement = document.getElementById('custom-style-preview');
    if (!styleElement) {
        styleElement = document.createElement('style');
        styleElement.id = 'custom-style-preview';
        document.head.appendChild(styleElement);
    }
    styleElement.textContent = css;
}

function showEmptyBuilder() {
    console.log('Showing empty builder for new page');
    
    const builderContainer = document.getElementById('builder-container') || 
                            document.querySelector('.builder-content') ||
                            document.querySelector('.page-builder');
    
    if (builderContainer) {
        builderContainer.innerHTML = `
            <div class="empty-builder text-center py-5">
                <h3>Start Building Your Page!</h3>
                <p>Add blocks using the toolbar above to create your page.</p>
            </div>
        `;
    }
}

function showPageSelector() {
    // Show a page selector or redirect to billing if no pages exist
    console.log('No page specified, checking user pages...');
    
    fetch(`${API_BASE}/my-pages`, {
        credentials: 'include'
    })
    .then(response => response.json())
    .then(data => {
        if (data.success && data.pages.length > 0) {
            // Show page selector
            showPageSelectorModal(data.pages);
        } else {
            // Redirect to billing to create a page
            alert('You need to create a page first before using the builder.');
            window.location.href = '/pages/billing';
        }
    })
    .catch(error => {
        console.error('Error loading pages:', error);
        alert('Error loading your pages. Please try again.');
        window.location.href = '/pages/billing';
    });
}

function showPageSelectorModal(pages) {
    // Create a modal to select which page to edit
    const modal = document.createElement('div');
    modal.className = 'modal fade';
    modal.innerHTML = `
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Select Page to Edit</h5>
                </div>
                <div class="modal-body">
                    <p>Which page would you like to edit?</p>
                    <div class="list-group">
                        ${pages.map(page => `
                            <a href="/pages/builder.html?page=${page.subdomain}" class="list-group-item list-group-item-action">
                                <h6>${page.title}</h6>
                                <small class="text-muted">${page.subdomain} - ${page.plan} plan</small>
                            </a>
                        `).join('')}
                    </div>
                </div>
                <div class="modal-footer">
                    <a href="/pages/billing" class="btn btn-primary">Create New Page</a>
                </div>
            </div>
        </div>
    `;
    
    document.body.appendChild(modal);
    
    // Show the modal using Bootstrap
    const bsModal = new bootstrap.Modal(modal);
    bsModal.show();
}

// Save function - implement this based on your builder
async function savePage() {
    if (!currentSubdomain) {
        alert('No page loaded to save');
        return;
    }
    
    try {
        // Collect blocks from builder - adapt this to your implementation
        const blocks = collectBlocksFromBuilder();
        const customCSS = getCustomCSS();
        const title = getPageTitle();
        
        const response = await fetch(`${API_BASE}/page/${currentSubdomain}`, {
            method: 'PUT',
            headers: { 'Content-Type': 'application/json' },
            credentials: 'include',
            body: JSON.stringify({
                page_data: JSON.stringify({ blocks }),
                custom_css: customCSS,
                title: title
            })
        });
        
        const data = await response.json();
        if (data.success) {
            alert('Page saved successfully!');
        } else {
            alert('Error saving page: ' + data.message);
        }
        
    } catch (error) {
        console.error('Error saving page:', error);
        alert('Error saving page. Please try again.');
    }
}

// Helper functions - implement these based on your builder structure
function collectBlocksFromBuilder() {
    // This needs to be implemented based on your specific builder
    const builderBlocks = document.querySelectorAll('.builder-block');
    const blocks = [];
    
    builderBlocks.forEach(blockElement => {
        // Extract block data from the DOM element
        // This is a basic example - adapt to your builder
        const blockType = blockElement.dataset.blockType;
        const blockData = {
            type: blockType,
            content: {} // Extract content based on block type
        };
        blocks.push(blockData);
    });
    
    return blocks;
}

function getCustomCSS() {
    const cssTextarea = document.getElementById('custom-css') || 
                       document.querySelector('textarea[placeholder*="css"]');
    return cssTextarea ? cssTextarea.value : '';
}

function getPageTitle() {
    const titleInput = document.getElementById('page-title') || 
                      document.querySelector('input[placeholder*="title"]');
    return titleInput ? titleInput.value : (currentPage ? currentPage.title : 'My Page');
}
    </script>
</body>
</html>