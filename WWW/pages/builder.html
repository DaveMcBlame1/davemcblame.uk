<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Page Builder - Multigrounds</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        .builder-sidebar {
            background: #f8f9fa;
            min-height: 100vh;
            border-right: 1px solid #dee2e6;
        }
        
        .block-item {
            cursor: grab;
            transition: transform 0.2s;
        }
        
        .block-item:hover {
            transform: translateY(-2px);
        }
        
        .preview-area {
            min-height: 100vh;
            background: white;
        }
        
        .editable-block {
            border: 2px dashed transparent;
            position: relative;
            transition: border-color 0.2s;
        }
        
        .editable-block:hover {
            border-color: #007bff;
        }
        
        .block-controls {
            position: absolute;
            top: -10px;
            right: -10px;
            opacity: 0;
            transition: opacity 0.2s;
        }
        
        .editable-block:hover .block-controls {
            opacity: 1;
        }
        
        .drop-zone {
            min-height: 50px;
            border: 2px dashed #ccc;
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 10px 0;
            transition: border-color 0.2s;
        }
        
        .drop-zone.drag-over {
            border-color: #007bff;
            background-color: rgba(0, 123, 255, 0.1);
        }
    </style>
</head>
<body>
    <div class="container-fluid">
        <div class="row">
            <!-- Sidebar -->
            <div class="col-md-3 builder-sidebar p-4">
                <div class="d-flex justify-content-between align-items-center mb-4">
                    <h4>Page Builder</h4>
                    <button class="btn btn-success btn-sm" onclick="savePage()">
                        <i class="fas fa-save"></i> Save
                    </button>
                </div>
                
                <!-- Page Settings -->
                <div class="card mb-4">
                    <div class="card-body">
                        <h6>Page Settings</h6>
                        <div class="mb-3">
                            <label class="form-label">Page Title</label>
                            <input type="text" id="page-title" class="form-control" placeholder="My Awesome Page">
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Subdomain</label>
                            <div class="input-group">
                                <input type="text" id="page-subdomain" class="form-control" placeholder="mypage">
                                <span class="input-group-text">.multigrounds.org</span>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Building Blocks -->
                <div class="card">
                    <div class="card-body">
                        <h6>Drag & Drop Blocks</h6>
                        
                        <div class="block-item card mb-2" draggable="true" data-block-type="header">
                            <div class="card-body py-2">
                                <i class="fas fa-heading text-primary"></i> Header
                            </div>
                        </div>
                        
                        <div class="block-item card mb-2" draggable="true" data-block-type="text">
                            <div class="card-body py-2">
                                <i class="fas fa-paragraph text-success"></i> Text
                            </div>
                        </div>
                        
                        <div class="block-item card mb-2" draggable="true" data-block-type="image">
                            <div class="card-body py-2">
                                <i class="fas fa-image text-warning"></i> Image
                            </div>
                        </div>
                        
                        <div class="block-item card mb-2" draggable="true" data-block-type="button">
                            <div class="card-body py-2">
                                <i class="fas fa-mouse-pointer text-info"></i> Button
                            </div>
                        </div>
                        
                        <div class="block-item card mb-2" draggable="true" data-block-type="spacer">
                            <div class="card-body py-2">
                                <i class="fas fa-arrows-alt-v text-secondary"></i> Spacer
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Preview Area -->
            <div class="col-md-9 preview-area p-0">
                <div class="bg-light p-3 border-bottom">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <span class="badge bg-primary">Preview Mode</span>
                            <span id="page-url" class="ms-2 text-muted">multigrounds.org/yourpage</span>
                        </div>
                        <div>
                            <button class="btn btn-outline-primary btn-sm" onclick="previewPage()">
                                <i class="fas fa-eye"></i> Preview
                            </button>
                            <button class="btn btn-primary btn-sm" onclick="publishPage()">
                                <i class="fas fa-globe"></i> Publish
                            </button>
                        </div>
                    </div>
                </div>
                
                <div id="canvas" class="p-4">
                    <div class="drop-zone">
                        <span class="text-muted">Drag blocks here to start building your page</span>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Block Editor Modal -->
    <div class="modal fade" id="blockEditorModal">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Edit Block</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body" id="block-editor-content">
                    <!-- Dynamic content based on block type -->
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-primary" onclick="saveBlockChanges()">Save Changes</button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="builder.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', async () => {
    // Get page parameter from URL
    const urlParams = new URLSearchParams(window.location.search);
    const pageSubdomain = urlParams.get('page');
    
    if (pageSubdomain) {
        console.log('Loading page:', pageSubdomain);
        
        // Update the page selector/input to show the current page
        const pageInput = document.getElementById('page-subdomain') || 
                         document.querySelector('input[placeholder*="yourname"]') ||
                         document.querySelector('.page-selector');
        
        if (pageInput) {
            pageInput.value = pageSubdomain;
            pageInput.placeholder = pageSubdomain;
        }
        
        // Load the page data
        try {
            const response = await fetch(`https://api.multigrounds.org:10065/api/page/${pageSubdomain}`, {
                credentials: 'include'
            });
            const data = await response.json();
            
            if (data.success) {
                // Load the page data into the builder
                window.currentPage = data.page;
                window.currentSubdomain = pageSubdomain;
                
                // Update title field if it exists
                const titleInput = document.getElementById('page-title');
                if (titleInput) {
                    titleInput.value = data.page.title;
                }
                
                // Load blocks if they exist
                if (data.page.page_data) {
                    const pageData = JSON.parse(data.page.page_data);
                    if (pageData.blocks) {
                        loadBlocksIntoBuilder(pageData.blocks);
                    }
                }
                
                // Load custom CSS if it exists
                const cssTextarea = document.getElementById('custom-css');
                if (cssTextarea && data.page.custom_css) {
                    cssTextarea.value = data.page.custom_css;
                }
                
                console.log('Page loaded successfully:', data.page);
            } else {
                console.error('Failed to load page:', data.message);
                alert('Failed to load page: ' + data.message);
            }
        } catch (error) {
            console.error('Error loading page:', error);
            alert('Error loading page. Please try again.');
        }
    } else {
        console.log('No page parameter found, showing default state');
    }
});

// Helper function to load blocks into the builder
function loadBlocksIntoBuilder(blocks) {
    // This depends on your builder implementation
    // You'll need to adapt this to match your specific builder structure
    
    if (window.loadBlocks && typeof window.loadBlocks === 'function') {
        window.loadBlocks(blocks);
    } else if (window.pageBuilder && window.pageBuilder.loadBlocks) {
        window.pageBuilder.loadBlocks(blocks);
    }
    
    console.log('Loaded blocks into builder:', blocks);
}
    </script>
</body>
</html>