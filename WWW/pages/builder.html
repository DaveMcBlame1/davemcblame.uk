<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Page Builder - Multigrounds</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        .builder-sidebar {
            background: #f8f9fa;
            min-height: 100vh;
            border-right: 1px solid #dee2e6;
        }
        
        .block-item {
            cursor: grab;
            transition: transform 0.2s;
        }
        
        .block-item:hover {
            transform: translateY(-2px);
        }
        
        .preview-area {
            min-height: 100vh;
            background: white;
        }
        
        .editable-block {
            border: 2px dashed transparent;
            position: relative;
            transition: border-color 0.2s;
        }
        
        .editable-block:hover {
            border-color: #007bff;
        }
        
        .block-controls {
            position: absolute;
            top: -10px;
            right: -10px;
            opacity: 0;
            transition: opacity 0.2s;
        }
        
        .editable-block:hover .block-controls {
            opacity: 1;
        }
        
        .drop-zone {
            min-height: 50px;
            border: 2px dashed #ccc;
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 10px 0;
            transition: border-color 0.2s;
        }
        
        .drop-zone.drag-over {
            border-color: #007bff;
            background-color: rgba(0, 123, 255, 0.1);
        }
    </style>
</head>
<body>
    <div class="container-fluid">
        <div class="row">
            <!-- Sidebar -->
            <div class="col-md-3 builder-sidebar p-4">
                <div class="d-flex justify-content-between align-items-center mb-4">
                    <h4>Page Builder</h4>
                    <button class="btn btn-success btn-sm" onclick="savePage()">
                        <i class="fas fa-save"></i> Save
                    </button>
                </div>
                
                <!-- Page Settings -->
                <div class="card mb-4">
                    <div class="card-body">
                        <h6>Page Settings</h6>
                        <div class="mb-3">
                            <label class="form-label">Page Title</label>
                            <input type="text" id="page-title" class="form-control" placeholder="My Awesome Page">
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Subdomain</label>
                            <div class="input-group">
                                <input type="text" id="page-subdomain" class="form-control" placeholder="mypage">
                                <span class="input-group-text">.multigrounds.org</span>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Building Blocks -->
                <div class="card">
                    <div class="card-body">
                        <h6>Drag & Drop Blocks</h6>
                        
                        <div class="block-item card mb-2" draggable="true" data-block-type="header">
                            <div class="card-body py-2">
                                <i class="fas fa-heading text-primary"></i> Header
                            </div>
                        </div>
                        
                        <div class="block-item card mb-2" draggable="true" data-block-type="text">
                            <div class="card-body py-2">
                                <i class="fas fa-paragraph text-success"></i> Text
                            </div>
                        </div>
                        
                        <div class="block-item card mb-2" draggable="true" data-block-type="image">
                            <div class="card-body py-2">
                                <i class="fas fa-image text-warning"></i> Image
                            </div>
                        </div>
                        
                        <div class="block-item card mb-2" draggable="true" data-block-type="button">
                            <div class="card-body py-2">
                                <i class="fas fa-mouse-pointer text-info"></i> Button
                            </div>
                        </div>
                        
                        <div class="block-item card mb-2" draggable="true" data-block-type="spacer">
                            <div class="card-body py-2">
                                <i class="fas fa-arrows-alt-v text-secondary"></i> Spacer
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Preview Area -->
            <div class="col-md-9 preview-area p-0">
                <div class="bg-light p-3 border-bottom">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <span class="badge bg-primary">Preview Mode</span>
                            <span id="page-url" class="ms-2 text-muted">multigrounds.org/yourpage</span>
                        </div>
                        <div>
                            <button class="btn btn-outline-primary btn-sm" onclick="previewPage()">
                                <i class="fas fa-eye"></i> Preview
                            </button>
                            <button class="btn btn-primary btn-sm" onclick="publishPage()">
                                <i class="fas fa-globe"></i> Publish
                            </button>
                        </div>
                    </div>
                </div>
                
                <div id="canvas" class="p-4">
                    <div class="drop-zone">
                        <span class="text-muted">Drag blocks here to start building your page</span>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Block Editor Modal -->
    <div class="modal fade" id="blockEditorModal">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Edit Block</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body" id="block-editor-content">
                    <!-- Dynamic content based on block type -->
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-primary" onclick="saveBlockChanges()">Save Changes</button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="builder.js"></script>
    <script>
let currentUser = null;
let currentPage = null;
let currentSubdomain = null;

document.addEventListener('DOMContentLoaded', async () => {
    console.log('Builder loaded, initializing...');
    
    // Use the API_BASE from builder.js - make sure it's set correctly there
    const API_BASE = window.API_BASE || 'https://api.multigrounds.org:10065/api';
    
    // First check if user is logged in
    try {
        const response = await fetch(`${API_BASE}/check-login`, {
            credentials: 'include'
        });
        const data = await response.json();
        
        if (!data.success || !data.logged_in) {
            alert('Please log in first to use the page builder.');
            window.location.href = '/pages/support';
            return;
        }
        
        currentUser = data.user;
        console.log('User logged in:', currentUser.username);
        
        // Get page parameter from URL
        const urlParams = new URLSearchParams(window.location.search);
        const pageSubdomain = urlParams.get('page');
        
        if (pageSubdomain) {
            console.log('Loading page:', pageSubdomain);
            await loadPageForEditing(pageSubdomain);
        } else {
            console.log('No page parameter found, showing default state');
            showPageSelector();
        }
        
    } catch (error) {
        console.error('Error checking login:', error);
        alert('Error checking login status. Please try again.');
        window.location.href = '/pages/support';
    }
});

async function loadPageForEditing(subdomain) {
    const API_BASE = window.API_BASE || 'https://api.multigrounds.org:10065/api';
    
    try {
        const response = await fetch(`${API_BASE}/page/${subdomain}`, {
            credentials: 'include'
        });
        const data = await response.json();
        
        if (data.success) {
            if (!data.page.is_owner) {
                alert('You can only edit pages that you own.');
                window.location.href = '/pages/billing';
                return;
            }
            
            currentPage = data.page;
            currentSubdomain = subdomain;
            
            console.log('Page loaded successfully:', data.page);
            
            // Update the page info display
            updatePageDisplay(data.page);
            
            // Load the page data into the builder
            if (data.page.page_data) {
                const pageData = JSON.parse(data.page.page_data);
                if (pageData.blocks && pageData.blocks.length > 0) {
                    loadBlocksIntoCanvas(pageData.blocks);
                } else {
                    showEmptyBuilder();
                }
            } else {
                showEmptyBuilder();
            }
            
        } else {
            console.error('Failed to load page:', data.message);
            alert('Failed to load page: ' + data.message);
            window.location.href = '/pages/billing';
        }
    } catch (error) {
        console.error('Error loading page:', error);
        alert('Error loading page. Please try again.');
        window.location.href = '/pages/billing';
    }
}

function updatePageDisplay(page) {
    // Update page title
    const titleInput = document.getElementById('page-title');
    if (titleInput) {
        titleInput.value = page.title;
    }
    
    // Update subdomain display (disable editing after creation)
    const subdomainInput = document.getElementById('page-subdomain');
    if (subdomainInput) {
        subdomainInput.value = page.subdomain;
        subdomainInput.disabled = true;
        subdomainInput.style.backgroundColor = '#e9ecef';
    }
    
    // Update page URL display
    const urlElement = document.getElementById('page-url');
    if (urlElement) {
        urlElement.innerHTML = `<a href="https://api.multigrounds.org/pages/${page.subdomain}" target="_blank" class="text-decoration-none">
            multigrounds.org/${page.subdomain} <i class="fas fa-external-link-alt ms-1"></i>
        </a>`;
    }
}

function loadBlocksIntoCanvas(blocks) {
    console.log('Loading blocks into canvas:', blocks);
    
    const canvas = document.getElementById('canvas');
    if (!canvas) {
        console.error('Canvas element not found');
        return;
    }
    
    // Clear existing content
    canvas.innerHTML = '';
    
    // Add each block to the canvas
    blocks.forEach((block, index) => {
        const blockElement = createCanvasBlock(block, index);
        canvas.appendChild(blockElement);
        
        // Add drop zone after each block
        const dropZone = createDropZone();
        canvas.appendChild(dropZone);
    });
    
    // Always end with a drop zone
    if (blocks.length === 0) {
        const dropZone = createDropZone();
        dropZone.innerHTML = '<span class="text-muted">Drag blocks here to start building your page</span>';
        canvas.appendChild(dropZone);
    }
}

function createCanvasBlock(block, index) {
    const blockDiv = document.createElement('div');
    blockDiv.className = 'editable-block mb-3 p-3';
    blockDiv.dataset.blockIndex = index;
    blockDiv.dataset.blockType = block.type;
    
    const content = block.content || {};
    
    // Add block controls
    const controls = document.createElement('div');
    controls.className = 'block-controls';
    controls.innerHTML = `
        <div class="btn-group btn-group-sm">
            <button class="btn btn-primary btn-sm" onclick="editBlock(${index})" title="Edit">
                <i class="fas fa-edit"></i>
            </button>
            <button class="btn btn-danger btn-sm" onclick="deleteBlock(${index})" title="Delete">
                <i class="fas fa-trash"></i>
            </button>
        </div>
    `;
    
    blockDiv.appendChild(controls);
    
    // Add block content based on type
    const contentDiv = document.createElement('div');
    
    switch (block.type) {
        case 'header':
            contentDiv.innerHTML = `<h${content.level || 1} class="text-${content.align || 'left'} mb-0">${content.text || 'Header'}</h${content.level || 1}>`;
            break;
            
        case 'text':
            contentDiv.innerHTML = `<p class="text-${content.align || 'left'} mb-0">${content.text || 'Text content'}</p>`;
            break;
            
        case 'image':
            if (content.src) {
                contentDiv.innerHTML = `
                    <div class="text-${content.align || 'center'}">
                        <img src="${content.src}" alt="${content.alt || ''}" class="img-fluid" style="max-width: ${content.maxWidth || '100%'}">
                    </div>
                `;
            } else {
                contentDiv.innerHTML = `<div class="text-center p-4 bg-light border">No image selected</div>`;
            }
            break;
            
        case 'button':
            contentDiv.innerHTML = `
                <div class="text-${content.align || 'center'}">
                    <a href="${content.link || '#'}" class="btn btn-${content.style || 'primary'}">${content.text || 'Button'}</a>
                </div>
            `;
            break;
            
        case 'spacer':
            contentDiv.innerHTML = `<div style="height: ${content.height || '50px'};" class="bg-light border"></div>`;
            break;
            
        default:
            contentDiv.innerHTML = `<p class="text-muted">Unknown block type: ${block.type}</p>`;
    }
    
    blockDiv.appendChild(contentDiv);
    return blockDiv;
}

function createDropZone() {
    const dropZone = document.createElement('div');
    dropZone.className = 'drop-zone';
    dropZone.innerHTML = '<span class="text-muted">Drop block here</span>';
    
    // Add drop zone event listeners
    dropZone.addEventListener('dragover', handleDragOver);
    dropZone.addEventListener('drop', handleDrop);
    dropZone.addEventListener('dragenter', (e) => {
        e.preventDefault();
        dropZone.classList.add('drag-over');
    });
    dropZone.addEventListener('dragleave', (e) => {
        if (!dropZone.contains(e.relatedTarget)) {
            dropZone.classList.remove('drag-over');
        }
    });
    
    return dropZone;
}

function showEmptyBuilder() {
    const canvas = document.getElementById('canvas');
    if (canvas) {
        canvas.innerHTML = `
            <div class="drop-zone">
                <span class="text-muted">Drag blocks here to start building your page</span>
            </div>
        `;
        
        const dropZone = canvas.querySelector('.drop-zone');
        dropZone.addEventListener('dragover', handleDragOver);
        dropZone.addEventListener('drop', handleDrop);
        dropZone.addEventListener('dragenter', (e) => {
            e.preventDefault();
            dropZone.classList.add('drag-over');
        });
        dropZone.addEventListener('dragleave', (e) => {
            if (!dropZone.contains(e.relatedTarget)) {
                dropZone.classList.remove('drag-over');
            }
        });
    }
}

function showPageSelector() {
    const API_BASE = window.API_BASE || 'https://api.multigrounds.org:10065/api';
    
    fetch(`${API_BASE}/my-pages`, {
        credentials: 'include'
    })
    .then(response => response.json())
    .then(data => {
        if (data.success && data.pages.length > 0) {
            showPageSelectorModal(data.pages);
        } else {
            alert('You need to create a page first before using the builder.');
            window.location.href = '/pages/billing';
        }
    })
    .catch(error => {
        console.error('Error loading pages:', error);
        alert('Error loading your pages. Please try again.');
        window.location.href = '/pages/billing';
    });
}

function showPageSelectorModal(pages) {
    const modal = document.createElement('div');
    modal.className = 'modal fade';
    modal.innerHTML = `
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Select Page to Edit</h5>
                </div>
                <div class="modal-body">
                    <p>Which page would you like to edit?</p>
                    <div class="list-group">
                        ${pages.map(page => `
                            <a href="/pages/builder.html?page=${page.subdomain}" class="list-group-item list-group-item-action">
                                <h6>${page.title}</h6>
                                <small class="text-muted">${page.subdomain} - ${page.plan} plan</small>
                            </a>
                        `).join('')}
                    </div>
                </div>
                <div class="modal-footer">
                    <a href="/pages/billing" class="btn btn-primary">Create New Page</a>
                </div>
            </div>
        </div>
    `;
    
    document.body.appendChild(modal);
    const bsModal = new bootstrap.Modal(modal);
    bsModal.show();
}

// Drag and Drop functionality
function handleDragOver(e) {
    e.preventDefault();
    e.dataTransfer.dropEffect = 'copy';
}

function handleDrop(e) {
    e.preventDefault();
    e.currentTarget.classList.remove('drag-over');
    
    const blockType = e.dataTransfer.getData('text/plain');
    if (blockType) {
        addBlockToCanvas(blockType, e.currentTarget);
    }
}

function addBlockToCanvas(blockType, dropZone) {
    const newBlock = createDefaultBlock(blockType);
    const blockElement = createCanvasBlock(newBlock, Date.now()); // Use timestamp as temp index
    
    // Replace drop zone with block + new drop zone
    const newDropZone = createDropZone();
    dropZone.parentNode.insertBefore(blockElement, dropZone);
    dropZone.parentNode.insertBefore(newDropZone, dropZone.nextSibling);
}

function createDefaultBlock(blockType) {
    const defaults = {
        header: {
            type: 'header',
            content: {
                text: 'New Header',
                level: 1,
                align: 'left'
            }
        },
        text: {
            type: 'text',
            content: {
                text: 'This is a text block. Click edit to change this content.',
                align: 'left'
            }
        },
        image: {
            type: 'image',
            content: {
                src: '',
                alt: 'Image',
                align: 'center',
                maxWidth: '100%'
            }
        },
        button: {
            type: 'button',
            content: {
                text: 'Click Me',
                link: '#',
                style: 'primary',
                align: 'center'
            }
        },
        spacer: {
            type: 'spacer',
            content: {
                height: '50px'
            }
        }
    };
    
    return defaults[blockType] || defaults.text;
}

// Save functionality
async function savePage() {
    if (!currentSubdomain) {
        alert('No page loaded to save');
        return;
    }
    
    const API_BASE = window.API_BASE || 'https://api.multigrounds.org:10065/api';
    
    try {
        const blocks = collectBlocksFromCanvas();
        const title = document.getElementById('page-title').value || currentPage.title;
        
        const response = await fetch(`${API_BASE}/page/${currentSubdomain}`, {
            method: 'PUT',
            headers: { 'Content-Type': 'application/json' },
            credentials: 'include',
            body: JSON.stringify({
                page_data: JSON.stringify({ blocks }),
                title: title
            })
        });
        
        const data = await response.json();
        if (data.success) {
            alert('Page saved successfully!');
        } else {
            alert('Error saving page: ' + data.message);
        }
        
    } catch (error) {
        console.error('Error saving page:', error);
        alert('Error saving page. Please try again.');
    }
}

function collectBlocksFromCanvas() {
    const blockElements = document.querySelectorAll('#canvas .editable-block');
    const blocks = [];
    
    blockElements.forEach(blockElement => {
        const blockType = blockElement.dataset.blockType;
        // This is a simplified collection - you'd need to extract actual content
        const block = {
            type: blockType,
            content: {} // Extract actual content based on block type
        };
        blocks.push(block);
    });
    
    return blocks;
}

// Initialize drag and drop for sidebar blocks
document.addEventListener('DOMContentLoaded', () => {
    const blockItems = document.querySelectorAll('.block-item');
    blockItems.forEach(item => {
        item.addEventListener('dragstart', (e) => {
            const blockType = e.target.closest('.block-item').dataset.blockType;
            e.dataTransfer.setData('text/plain', blockType);
        });
    });
});

// Preview and publish functions
function previewPage() {
    if (currentSubdomain) {
        window.open(`https://api.multigrounds.org/pages/${currentSubdomain}`, '_blank');
    } else {
        alert('Please save your page first');
    }
}

function publishPage() {
    // For now, just save the page (it's automatically "published")
    savePage();
}
    </script>
</body>
</html>