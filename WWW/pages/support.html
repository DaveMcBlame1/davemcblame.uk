<!DOCTYPE html>
<html lang="en">
<head>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
  <link rel="stylesheet" href="../css/bsdefault.css">
  <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/dompurify@3.0.9/dist/purify.min.js"></script>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <link rel="logo" href="Multigrounds.png" />
  <title>Support</title>
</head>
<body class="PP">
  <header class="header">
    <a href="/"> <img src="../Multigrounds.png" alt="Logo" class="logo"/></a>
    <div class="top-links">
      <a href="pages/billing">Get Started</a>
      <a href="pages/my-pages">My Pages</a>
    </div>
  </header>
    <main class="container py-4">
  <div class="row justify-content-center">
    <div class="col-lg-10 col-md-12">
      
      <!-- Login Form -->
      <div id="login-section" class="card mb-4">
        <div class="card-body">
          <h3>Login to Submit Tickets</h3>
          <form id="loginForm" onsubmit="handleLogin(event)">
            <div class="mb-3">
              <label for="username" class="form-label">Username</label>
              <input type="text" class="form-control" id="username" name="username" required>
            </div>
            <div class="mb-3">
              <label for="password" class="form-label">Password</label>
              <input type="password" class="form-control" id="password" name="password" required>
            </div>
            <div class="mb-3 form-check">
              <input type="checkbox" class="form-check-input" id="remember_me" name="remember_me">
              <label class="form-check-label" for="remember_me">
                Remember me (stay logged in for 30 days)
              </label>
            </div>
            <button type="submit" class="btn btn-primary w-100">Login</button>
            
            <!-- Add this section for sign up link -->
            <div class="text-center mt-3">
              <p class="mb-0">Don't have an account? 
                <a href="/pages/signup" class="btn btn-link p-0">Sign up here</a>
              </p>
            </div>
          </form>
        </div>
      </div>

      <!-- Registration Form -->
      <div id="register-section" class="card mb-4" style="display: none;">
        <div class="card-body">
          <h3>Create Account</h3>
          <form id="register-form">
            <div class="mb-3">
              <input type="text" id="reg-username" class="form-control" placeholder="Username" required>
            </div>
            <div class="mb-3">
              <input type="email" id="reg-email" class="form-control" placeholder="Email" required>
            </div>
            <div class="mb-3">
              <input type="password" id="reg-password" class="form-control" placeholder="Password" required>
            </div>
            <button type="submit" class="btn btn-success">Register</button>
            <button type="button" id="show-login" class="btn btn-link">Already have an account? Login</button>
          </form>
        </div>
      </div>

      <!-- Ticket System (hidden until logged in) -->
      <div id="ticket-section" style="display: none;">
        <div class="d-flex justify-content-between align-items-center mb-4">
          <h2>Support Tickets <span id="admin-badge" class="badge bg-warning" style="display: none;">Admin</span></h2>
          <button id="logout-btn" class="btn btn-outline-danger">Logout</button>
        </div>
        
        <!-- Create Ticket Form -->
        <div class="card mb-4">
          <div class="card-body">
            <h4>Submit New Ticket</h4>
            <form id="ticket-form">
              <div class="mb-3">
                <input type="text" id="ticket-title" class="form-control" placeholder="Ticket Title" required>
              </div>
              <div class="mb-3">
                <textarea id="ticket-description" class="form-control" rows="4" placeholder="Describe your issue..." required></textarea>
              </div>
              <div class="mb-3">
                <select id="ticket-priority" class="form-select">
                  <option value="low">Low Priority</option>
                  <option value="medium" selected>Medium Priority</option>
                  <option value="high">High Priority</option>
                </select>
              </div>
              <button type="submit" class="btn btn-primary">Submit Ticket</button>
            </form>
          </div>
        </div>

        <!-- Ticket List -->
        <div id="admin-tickets" style="display: none;">
          <div class="row">
            <!-- Active Tickets Column -->
            <div class="col-lg-8">
              <div class="card">
                <div class="card-header bg-primary text-white">
                  <h5 class="mb-0">
                    <i class="fas fa-exclamation-circle"></i> Active Tickets 
                    <span id="active-count" class="badge bg-light text-dark">0</span>
                  </h5>
                </div>
                <div class="card-body">
                  <div id="active-tickets-list">
                    <!-- Active tickets will be loaded here -->
                  </div>
                </div>
              </div>
            </div>
            
            <!-- Closed Tickets Column -->
            <div class="col-lg-4">
              <div class="card">
                <div class="card-header bg-success text-white">
                  <h5 class="mb-0">
                    <i class="fas fa-check-circle"></i> Closed Tickets 
                    <span id="closed-count" class="badge bg-light text-dark">0</span>
                  </h5>
                </div>
                <div class="card-body closed-tickets-column">
                  <div id="closed-tickets-list">
                    <!-- Closed tickets will be loaded here -->
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- User Tickets (single column for regular users) -->
        <div id="user-tickets" class="card">
          <div class="card-body">
            <h4>Your Tickets</h4>
            <div id="user-tickets-list">
              <!-- User tickets will be loaded here -->
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
  

</main>
<footer class="footer">
    <div class="container">
      <div class="row">
        <!-- Main Footer Content -->
        <div class="col-md align-self-center">
          <div class="row">
            <div class="col-6 col-md-auto mr-md-3 mt-1">
              <h6 class="text-bold-600">Company</h6>
              <ul>
                <li><a href="/pages/about">About Us</a></li>
                <li><a href="/pages/billing">Pricing</a></li>
              </ul>
            </div>
            
            <div class="col-6 col-md-auto mr-md-3 mt-1">
              <h6 class="text-bold-600">Resources</h6>
              <ul>
                <li><a href="/pages/my-pages">My Pages</a></li>
                <li><a href="/pages/support">Support</a></li>
              </ul>
            </div>
            
            <div class="col-6 col-md-auto mr-md-3 mt-1">
              <h6 class="text-bold-600">Legal</h6>
              <ul>
                <li><a href="/pages/policy">Privacy Policy</a></li>
                <li><a href="/pages/terms">Terms of Service</a></li>
              </ul>
            </div>
            
            <div class="col-6 col-md-auto mr-md-3 mt-1">
              <h6 class="text-bold-600">Contact</h6>
              <ul>
                <li><a href="mailto:davemcblame@multigrounds.org">Email Us</a></li>
              </ul>
            </div>
          </div>
        </div>
        
        <!-- Copyright Section -->
        <div class="col-md-auto text-center text-md-right mt-2 mt-md-2">
          <p class="mb-0">
            Â© 2025 Multigrounds<br>
            <span class="text-muted d-none d-md-inline mt-1">Made in US MO</span>
          </p>
        </div>
      </div>
    </div>
  </footer>

<!-- Create Ticket Modal (Keep only this one) -->
<div class="modal fade" id="createTicketModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Create New Support Ticket</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="create-ticket-form">
                    <div class="mb-3">
                        <label for="new-ticket-title" class="form-label">Title *</label>
                        <input type="text" class="form-control" id="new-ticket-title" required placeholder="Brief description of your issue">
                    </div>
                    <div class="mb-3">
                        <label for="new-ticket-description" class="form-label">Description *</label>
                        <textarea class="form-control" id="new-ticket-description" rows="4" required placeholder="Please describe your issue in detail..."></textarea>
                    </div>
                    <div class="mb-3">
                        <label for="new-ticket-priority" class="form-label">Priority</label>
                        <select class="form-control" id="new-ticket-priority">
                            <option value="low">Low</option>
                            <option value="medium" selected>Medium</option>
                            <option value="high">High</option>
                        </select>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" onclick="createTicket()">Create Ticket</button>
            </div>
        </div>
    </div>
</div>

<script>
const API_BASE = 'https://api.multigrounds.org:10065/api';
let currentUser = null;

document.addEventListener('DOMContentLoaded', async () => {
    console.log('Page loaded, checking login status...');
    
    // Set up form handlers first (with null checks)
    setupFormHandlers();
    
    // Check if user is logged in
    try {
        const response = await fetch(`${API_BASE}/check-login`, {
            credentials: 'include'
        });
        
        const data = await response.json();
        console.log('Login check response:', data);
        
        if (data.success && data.logged_in) {
            currentUser = data.user;
            console.log('User already logged in:', currentUser.username);
            
            showTicketSection();
        } else {
            console.log('User not logged in, showing login form');
            showLoginSection();
        }
    } catch (error) {
        console.error('Error checking login status:', error);
        showLoginSection();
    }
});

function setupFormHandlers() {
    // Only set up handlers if the elements exist
    const loginForm = document.getElementById('loginForm');
    const registerForm = document.getElementById('register-form');
    const logoutBtn = document.getElementById('logout-btn');
    const ticketForm = document.getElementById('ticket-form');
    
    // Login form handler
    if (loginForm) {
        loginForm.addEventListener('submit', handleLogin);
    }
    
    // Register form handler  
    if (registerForm) {
        registerForm.addEventListener('submit', handleRegister);
    }
    
    // Logout button handler
    if (logoutBtn) {
        logoutBtn.addEventListener('click', logout);
    }
    
    // Ticket form handler
    if (ticketForm) {
        ticketForm.addEventListener('submit', handleTicketSubmit);
    }
    
    // Navigation handlers - only if elements exist
    const showLoginBtn = document.getElementById('show-login');
    const showRegisterBtn = document.getElementById('show-register');
    
    if (showLoginBtn) {
        showLoginBtn.addEventListener('click', showLoginSection);
    }
    
    if (showRegisterBtn) {
        showRegisterBtn.addEventListener('click', showRegisterSection);
    }
    
    console.log('Form handlers set up successfully');
}

function showLoginSection() {
    const loginSection = document.getElementById('login-section');
    const registerSection = document.getElementById('register-section');
    const ticketSection = document.getElementById('ticket-section');
    
    if (loginSection) loginSection.style.display = 'block';
    if (registerSection) registerSection.style.display = 'none';
    if (ticketSection) ticketSection.style.display = 'none';
}

function showRegisterSection() {
    const loginSection = document.getElementById('login-section');
    const registerSection = document.getElementById('register-section');
    const ticketSection = document.getElementById('ticket-section');
    
    if (loginSection) loginSection.style.display = 'none';
    if (registerSection) registerSection.style.display = 'block';
    if (ticketSection) ticketSection.style.display = 'none';
}

function showTicketSection() {
    // Hide login/register sections
    const loginSection = document.getElementById('login-section');
    const registerSection = document.getElementById('register-section');
    const ticketSection = document.getElementById('ticket-section');
    
    if (loginSection) loginSection.style.display = 'none';
    if (registerSection) registerSection.style.display = 'none';
    if (ticketSection) ticketSection.style.display = 'block';
    
    // Show admin sections if user is admin
    if (currentUser && currentUser.is_admin) {
        const adminBadge = document.getElementById('admin-badge');
        const adminTickets = document.getElementById('admin-tickets');
        const userTickets = document.getElementById('user-tickets');
        
        if (adminBadge) adminBadge.style.display = 'inline';
        if (adminTickets) adminTickets.style.display = 'block';
        if (userTickets) userTickets.style.display = 'none';
        
        // Add bulk actions after a brief delay to ensure DOM is ready
        setTimeout(addBulkActionsSection, 100);
    } else {
        const adminTickets = document.getElementById('admin-tickets');
        const userTickets = document.getElementById('user-tickets');
        
        if (adminTickets) adminTickets.style.display = 'none';
        if (userTickets) userTickets.style.display = 'block';
    }
    
    loadTickets();
}

async function handleLogin(event) {
    event.preventDefault();
    
    const formData = new FormData(event.target);
    const loginData = {
        username: formData.get('username'),
        password: formData.get('password'),
        remember_me: formData.get('remember_me') === 'on'
    };
    
    try {
        const response = await fetch(`${API_BASE}/login`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            credentials: 'include',
            body: JSON.stringify(loginData)
        });
        
        const data = await response.json();
        
        if (data.success) {
            currentUser = data.user;
            console.log('Login successful:', currentUser.username);
            console.log('Remember me:', loginData.remember_me);
            
            showTicketSection();
        } else {
            alert('Login failed: ' + data.message);
        }
    } catch (error) {
        console.error('Login error:', error);
        alert('Login error. Please try again.');
    }
}

async function handleRegister(event) {
    event.preventDefault();
    const username = document.getElementById('reg-username').value.trim();
    const email = document.getElementById('reg-email').value.trim();
    const password = document.getElementById('reg-password').value;
    
    if (!username || !email || !password) {
        alert('Please fill in all fields');
        return;
    }
    
    try {
        const response = await fetch(`${API_BASE}/register`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            credentials: 'include',
            body: JSON.stringify({ username, email, password })
        });
        
        const data = await response.json();
        alert(data.message);
        
        if (data.success) {
            event.target.reset();
            showLoginSection(); // Show login after successful registration
        }
    } catch (error) {
        console.error('Registration error:', error);
        alert('Registration failed. Please try again.');
    }
}

async function handleTicketSubmit(event) {
    event.preventDefault();
    const title = document.getElementById('ticket-title').value.trim();
    const description = document.getElementById('ticket-description').value.trim();
    const priority = document.getElementById('ticket-priority').value;
    
    if (!title || !description) {
        alert('Please fill in all required fields');
        return;
    }
    
    try {
        const response = await fetch(`${API_BASE}/tickets`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            credentials: 'include',
            body: JSON.stringify({ title, description, priority })
        });
        
        const data = await response.json();
        if (data.success) {
            alert('Ticket created successfully!');
            event.target.reset();
            loadTickets();
        } else {
            alert('Error: ' + data.message);
        }
    } catch (error) {
        console.error('Error creating ticket:', error);
        alert('Error creating ticket. Please try again.');
    }
}

async function logout() {
    try {
        const response = await fetch(`${API_BASE}/logout`, {
            method: 'POST',
            credentials: 'include'
        });
        
        const data = await response.json();
        if (data.success) {
            currentUser = null;
            console.log('Logged out successfully');
            
            // Show login section
            showLoginSection();
            
            // Clear login form
            const loginForm = document.getElementById('loginForm');
            if (loginForm) loginForm.reset();
        } else {
            console.error('Logout failed:', data.message);
        }
    } catch (error) {
        console.error('Logout error:', error);
        // Fallback - still show login section
        currentUser = null;
        showLoginSection();
    }
}

async function loadTickets() {
    try {
        const response = await fetch(`${API_BASE}/tickets`, {
            credentials: 'include'
        });
        const data = await response.json();
        
        if (data.success) {
            displayTickets(data.tickets);
        } else {
            console.error('Failed to load tickets:', data.message);
        }
    } catch (error) {
        console.error('Error loading tickets:', error);
    }
}

function displayTickets(tickets) {
    if (currentUser && currentUser.is_admin) {
        displayAdminTickets(tickets);
    } else {
        displayUserTickets(tickets.user || []);
    }
}

function displayAdminTickets(tickets) {
    const activeList = document.getElementById('active-tickets-list');
    const closedList = document.getElementById('closed-tickets-list');
    const activeCount = document.getElementById('active-count');
    const closedCount = document.getElementById('closed-count');
    
    const activeTickets = tickets.open || [];
    const closedTickets = tickets.closed || [];
    
    if (activeCount) activeCount.textContent = activeTickets.length;
    if (closedCount) closedCount.textContent = closedTickets.length;
    
    // Display active tickets
    if (activeList) {
        if (activeTickets.length === 0) {
            activeList.innerHTML = '<p class="text-muted">No active tickets</p>';
        } else {
            activeList.innerHTML = activeTickets.map(ticket => createTicketHTML(ticket)).join('');
        }
    }
    
    // Display closed tickets
    if (closedList) {
        if (closedTickets.length === 0) {
            closedList.innerHTML = '<p class="text-muted">No closed tickets</p>';
        } else {
            closedList.innerHTML = closedTickets.map(ticket => createTicketHTML(ticket, true)).join('');
        }
    }
}

function displayUserTickets(tickets) {
    const userList = document.getElementById('user-tickets-list');
    
    if (userList) {
        if (tickets.length === 0) {
            userList.innerHTML = `
                <div class="text-center py-5">
                    <i class="fas fa-ticket-alt fa-3x text-muted mb-3"></i>
                    <h5 class="text-muted">No tickets yet</h5>
                    <p class="text-muted">Submit your first support ticket using the form above.</p>
                </div>
            `;
        } else {
            userList.innerHTML = tickets.map(ticket => createTicketHTML(ticket)).join('');
        }
    }
}

function createTicketHTML(ticket, isCompact = false) {
    const priorityColor = ticket.priority === 'high' ? 'danger' : ticket.priority === 'medium' ? 'warning' : 'secondary';
    const statusColor = ticket.status === 'open' ? 'success' : ticket.status === 'closed' ? 'secondary' : 'primary';
    const isTicketClosed = ticket.status === 'closed';
    const canReply = !isTicketClosed;

    // Use marked to render markdown safely
    function renderMarkdown(text) {
        return marked.parse(text || '', { breaks: true, gfm: true });
    }

    // When displaying ticket/comment content:
    function renderMarkdownSafe(text) {
        return DOMPurify.sanitize(marked.parse(text || '', { breaks: true, gfm: true }));
    }

    return `
        <div class="card mb-3 ticket-priority-${ticket.priority}">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h6 class="mb-0">${ticket.title}</h6>
                <div>
                    <span class="badge bg-${priorityColor} me-2">${ticket.priority}</span>
                    <span class="badge bg-${statusColor}">${ticket.status}</span>
                </div>
            </div>
            <div class="card-body">
                ${isCompact ? '' : `<div class="mb-2 ticket-description-md">${renderMarkdownSafe(ticket.description)}</div>`}
                <small class="text-muted">
                    Created: ${new Date(ticket.created_at).toLocaleDateString()}
                    ${currentUser?.is_admin ? ` | By: ${ticket.username}` : ''}
                </small>
                
                ${ticket.comments && ticket.comments.length > 0 ? `
                    <div class="mt-3">
                        <h6>Comments:</h6>
                        <div class="comments-section" style="max-height: 300px; overflow-y: auto;">
                            ${ticket.comments.map(comment => `
                                <div class="border-start ps-3 mb-2 ${comment.is_admin_reply ? 'border-primary bg-light' : 'border-secondary'}">
                                    <strong>${comment.username}${comment.is_admin_reply ? ' (Admin)' : ''}:</strong>
                                    <div class="mb-1 comment-md">${renderMarkdown(comment.content)}</div>
                                    <small class="text-muted">${new Date(comment.created_at).toLocaleDateString()}</small>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                ` : ''}
                
                ${currentUser?.is_admin ? `
                    <div class="mt-3 border-top pt-3">
                        <h6>Admin Actions:</h6>
                        <div class="d-flex flex-wrap gap-2 mb-3">
                            ${ticket.status === 'open' ? `
                                <button class="btn btn-sm btn-success" onclick="updateTicketStatus(${ticket.id}, 'in_progress')">
                                    <i class="fas fa-play"></i> Start Working
                                </button>
                                <button class="btn btn-sm btn-secondary" onclick="updateTicketStatus(${ticket.id}, 'closed')">
                                    <i class="fas fa-times"></i> Close Ticket
                                </button>
                            ` : ticket.status === 'in_progress' ? `
                                <button class="btn btn-sm btn-success" onclick="updateTicketStatus(${ticket.id}, 'closed')">
                                    <i class="fas fa-check"></i> Mark as Resolved
                                </button>
                                <button class="btn btn-sm btn-warning" onclick="updateTicketStatus(${ticket.id}, 'open')">
                                    <i class="fas fa-undo"></i> Reopen
                                </button>
                            ` : `
                                <button class="btn btn-sm btn-warning" onclick="updateTicketStatus(${ticket.id}, 'open')">
                                    <i class="fas fa-undo"></i> Reopen Ticket
                                </button>
                            `}
                            <button class="btn btn-sm btn-danger" onclick="deleteTicket(${ticket.id})">
                                <i class="fas fa-trash"></i> Delete
                            </button>
                        </div>
                        
                        ${canReply ? `
                            <div class="mb-3">
                                <textarea class="form-control mb-2" id="admin-reply-${ticket.id}" placeholder="Add admin response..." rows="3"></textarea>
                                <button class="btn btn-sm btn-primary" onclick="addAdminReply(${ticket.id})">
                                    <i class="fas fa-reply"></i> Send Admin Reply
                                </button>
                            </div>
                        ` : `
                            <div class="alert alert-info">
                                <i class="fas fa-info-circle"></i> Ticket is closed. Reopen to add replies.
                            </div>
                        `}
                    </div>
                ` : `
                    ${canReply ? `
                        <div class="mt-3 border-top pt-3">
                            <h6>Add Reply:</h6>
                            <div class="mb-3">
                                <textarea class="form-control mb-2" id="user-reply-${ticket.id}" placeholder="Add your reply..." rows="3"></textarea>
                                <button class="btn btn-sm btn-primary" onclick="addUserReply(${ticket.id})">
                                    <i class="fas fa-reply"></i> Send Reply
                                </button>
                            </div>
                        </div>
                    ` : `
                        <div class="mt-3 border-top pt-3">
                            <div class="alert alert-secondary">
                                <i class="fas fa-lock"></i> This ticket is closed. No new replies can be added.
                            </div>
                        </div>
                    `}
                `}
            </div>
        </div>
    `;
}

// Modal functions (keeping for compatibility)
function showCreateTicketModal() {
    const modal = new bootstrap.Modal(document.getElementById('createTicketModal'));
    modal.show();
}

function createTicket() {
    const title = document.getElementById('new-ticket-title').value.trim();
    const description = document.getElementById('new-ticket-description').value.trim();
    const priority = document.getElementById('new-ticket-priority').value;
    
    if (!title || !description) {
        alert('Please fill in all required fields');
        return;
    }
    
    fetch(`${API_BASE}/tickets`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        credentials: 'include',
        body: JSON.stringify({ title, description, priority })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            alert('Ticket created successfully!');
            const modal = bootstrap.Modal.getInstance(document.getElementById('createTicketModal'));
            modal.hide();
            loadTickets();
            document.getElementById('create-ticket-form').reset();
        } else {
            alert('Error: ' + data.message);
        }
    })
    .catch(error => {
        console.error('Error creating ticket:', error);
        alert('Error creating ticket. Please try again.');
    });
}

async function updateTicketStatus(ticketId, newStatus) {
    if (!confirm(`Are you sure you want to change this ticket to ${newStatus}?`)) {
        return;
    }
    
    try {
        const response = await fetch(`${API_BASE}/tickets/${ticketId}/status`, {
            method: 'PUT',
            headers: { 'Content-Type': 'application/json' },
            credentials: 'include',
            body: JSON.stringify({ status: newStatus })
        });
        
        const data = await response.json();
        if (data.success) {
            alert('Ticket status updated successfully!');
            loadTickets(); // Reload tickets to reflect changes
        } else {
            alert('Error updating ticket: ' + data.message);
        }
    } catch (error) {
        console.error('Error updating ticket status:', error);
        alert('Error updating ticket status. Please try again.');
    }
}

async function deleteTicket(ticketId) {
    if (!confirm('Are you sure you want to delete this ticket? This action cannot be undone.')) {
        return;
    }
    
    try {
        const response = await fetch(`${API_BASE}/tickets/${ticketId}`, {
            method: 'DELETE',
            credentials: 'include'
        });
        
        const data = await response.json();
        if (data.success) {
            alert('Ticket deleted successfully!');
            loadTickets(); // Reload tickets to reflect changes
        } else {
            alert('Error deleting ticket: ' + data.message);
        }
    } catch (error) {
        console.error('Error deleting ticket:', error);
        alert('Error deleting ticket. Please try again.');
    }
}

async function addAdminReply(ticketId) {
    const replyTextarea = document.getElementById(`admin-reply-${ticketId}`);
    const content = replyTextarea.value.trim();
    
    if (!content) {
        alert('Please enter a reply message.');
        return;
    }
    
    try {
        const response = await fetch(`${API_BASE}/tickets/${ticketId}/comments`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            credentials: 'include',
            body: JSON.stringify({ 
                content: content,
                is_admin_reply: true 
            })
        });
        
        const data = await response.json();
        if (data.success) {
            alert('Admin reply added successfully!');
            replyTextarea.value = ''; // Clear the textarea
            loadTickets(); // Reload tickets to show the new reply
        } else {
            alert('Error adding reply: ' + data.message);
        }
    } catch (error) {
        console.error('Error adding admin reply:', error);
        alert('Error adding reply. Please try again.');
    }
}

async function addUserReply(ticketId) {
    const replyTextarea = document.getElementById(`user-reply-${ticketId}`);
    const content = replyTextarea.value.trim();
    
    if (!content) {
        alert('Please enter a reply message.');
        return;
    }
    
    try {
        const response = await fetch(`${API_BASE}/tickets/${ticketId}/comments`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            credentials: 'include',
            body: JSON.stringify({ 
                content: content,
                is_admin_reply: false 
            })
        });
        
        const data = await response.json();
        if (data.success) {
            alert('Reply added successfully!');
            replyTextarea.value = ''; // Clear the textarea
            loadTickets(); // Reload tickets to show the new reply
        } else {
            alert('Error adding reply: ' + data.message);
        }
    } catch (error) {
        console.error('Error adding user reply:', error);
        alert('Error adding reply. Please try again.');
    }
}

// Add a bulk actions section for admins
function addBulkActionsSection() {
    if (!currentUser?.is_admin) return;
    
    const adminTicketsDiv = document.getElementById('admin-tickets');
    if (!adminTicketsDiv) return;
    
    // Check if bulk actions already exist
    if (adminTicketsDiv.querySelector('.bulk-actions')) return;
    
    // Add bulk actions toolbar before the tickets
    const bulkActionsHTML = `
        <div class="card mb-3 bulk-actions">
            <div class="card-body">
                <h6>Bulk Actions</h6>
                <div class="d-flex gap-2 flex-wrap">
                    <button class="btn btn-sm btn-outline-success" onclick="bulkUpdateStatus('closed')">
                        <i class="fas fa-check-double"></i> Close All Open Tickets
                    </button>
                    <button class="btn btn-sm btn-outline-primary" onclick="bulkUpdateStatus('in_progress')">
                        <i class="fas fa-play-circle"></i> Mark All as In Progress
                    </button>
                    <button class="btn btn-sm btn-outline-info" onclick="refreshTickets()">
                        <i class="fas fa-sync"></i> Refresh
                    </button>
                </div>
            </div>
        </div>
    `;
    
    adminTicketsDiv.insertAdjacentHTML('afterbegin', bulkActionsHTML);
}

async function bulkUpdateStatus(newStatus) {
    if (!confirm(`Are you sure you want to update ALL open tickets to ${newStatus}?`)) {
        return;
    }
    
    try {
        const response = await fetch(`${API_BASE}/tickets/bulk-update`, {
            method: 'PUT',
            headers: { 'Content-Type': 'application/json' },
            credentials: 'include',
            body: JSON.stringify({ status: newStatus })
        });
        
        const data = await response.json();
        if (data.success) {
            alert(`Updated ${data.updated_count} tickets successfully!`);
            loadTickets();
        } else {
            alert('Error with bulk update: ' + data.message);
        }
    } catch (error) {
        console.error('Error with bulk update:', error);
        alert('Error with bulk update. Please try again.');
    }
}

function refreshTickets() {
    loadTickets();
}
</script>

<!-- Load Bootstrap JS -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script>
async function loadVersion() {
    const vars = await fetch("/globaldata.json")
        .then(r => r.json())
        .catch(e => console.error("Error fetching file", e));

    let versionElements = document.querySelectorAll(".version");
    for (const versionElement of versionElements) {
        versionElement.innerText = vars.version ?? "Not found";
    }
}

loadVersion();
</script>

</body>
</html>