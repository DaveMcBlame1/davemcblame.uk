<!DOCTYPE html>
<html lang="en">
<head>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
  <link rel="stylesheet" href="../css/bsdefault.css">
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <link rel="logo" href="Multigrounds.png" />
  <title>Support</title>
  <style>
    body {
      background-color: #f8f9fa;
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    }
    
    .header {
      background: white;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
      padding: 1rem 0;
    }
    
    .logo {
      height: 48px;
      border-radius: 8px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.2);
      transition: all 0.2s ease;
    }
    
    .logo:hover {
      box-shadow: 0 4px 15px rgba(0,0,0,0.3);
      transform: translateY(-1px);
    }
    
    .top-links a {
      font-size: 0.9rem;
      color: #495057;
      background: #f8f9fa;
      padding: 0.5em 1em;
      border-radius: 25px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.08);
      text-decoration: none;
      font-weight: 500;
      transition: all 0.2s ease;
      border: 1px solid #dee2e6;
    }
    
    .top-links a:hover {
      background: #e9ecef;
      color: #212529;
      text-decoration: none;
      transform: translateY(-1px);
      box-shadow: 0 4px 12px rgba(0,0,0,0.15);
    }
    
    .card {
      border: none;
      box-shadow: 0 4px 15px rgba(0,0,0,0.1);
      transition: all 0.3s ease;
    }
    
    .card:hover {
      box-shadow: 0 8px 25px rgba(0,0,0,0.15);
    }
    
    .btn {
      border-radius: 25px;
      font-weight: 500;
      padding: 0.5rem 1.5rem;
      transition: all 0.2s ease;
    }
    
    .btn:hover {
      transform: translateY(-1px);
      box-shadow: 0 4px 15px rgba(0,0,0,0.3);
    }
    
    .ticket-priority-high {
      border-left: 4px solid #dc3545 !important;
    }
    .ticket-priority-medium {
      border-left: 4px solid #ffc107 !important;
    }
    .ticket-priority-low {
      border-left: 4px solid #17a2b8 !important;
    }

    .closed-tickets-column {
      max-height: 600px;
      overflow-y: auto;
    }

    .priority-indicator {
      font-size: 1.1em;
      margin-right: 8px;
    }
    
    .footer {
      background: white;
      box-shadow: 0 -2px 10px rgba(0,0,0,0.1);
      margin-top: 3rem;
    }
  </style>
</head>
<body class="PP">
  <header class="header">
    <a href="/"> <img src="../Multigrounds.png" alt="Logo" class="logo"/></a>
    <div class="top-links">
      <a href="/pages/policy">PRIVACY POLICY</a>
      <a href="/pages/terms">TERMS OF SERVICE</a>
      <a href="/pages/billing">Purchase An Page</a>
      <a href="/pages/support">Support</a>
      <a href="/pages/my-pages">My Pages</a>
    </div>
  </header>
    <main class="container py-4">
  <div class="row justify-content-center">
    <div class="col-lg-10 col-md-12">
      
      <!-- Login Form -->
      <div id="login-section" class="card mb-4">
        <div class="card-body">
          <h3>Login to Submit Tickets</h3>
          <form id="login-form">
            <div class="mb-3">
              <input type="text" id="login-username" class="form-control" placeholder="Username" required>
            </div>
            <div class="mb-3">
              <input type="password" id="login-password" class="form-control" placeholder="Password" required>
            </div>
            <button type="submit" class="btn btn-primary">Login</button>
            <button type="button" id="show-register" class="btn btn-link">Need an account? Register</button>
          </form>
        </div>
      </div>

      <!-- Registration Form -->
      <div id="register-section" class="card mb-4" style="display: none;">
        <div class="card-body">
          <h3>Create Account</h3>
          <form id="register-form">
            <div class="mb-3">
              <input type="text" id="reg-username" class="form-control" placeholder="Username" required>
            </div>
            <div class="mb-3">
              <input type="email" id="reg-email" class="form-control" placeholder="Email" required>
            </div>
            <div class="mb-3">
              <input type="password" id="reg-password" class="form-control" placeholder="Password" required>
            </div>
            <button type="submit" class="btn btn-success">Register</button>
            <button type="button" id="show-login" class="btn btn-link">Already have an account? Login</button>
          </form>
        </div>
      </div>

      <!-- Ticket System (hidden until logged in) -->
      <div id="ticket-section" style="display: none;">
        <div class="d-flex justify-content-between align-items-center mb-4">
          <h2>Support Tickets <span id="admin-badge" class="badge bg-warning" style="display: none;">Admin</span></h2>
          <button id="logout-btn" class="btn btn-outline-danger">Logout</button>
        </div>
        
        <!-- Create Ticket Form -->
        <div class="card mb-4">
          <div class="card-body">
            <h4>Submit New Ticket</h4>
            <form id="ticket-form">
              <div class="mb-3">
                <input type="text" id="ticket-title" class="form-control" placeholder="Ticket Title" required>
              </div>
              <div class="mb-3">
                <textarea id="ticket-description" class="form-control" rows="4" placeholder="Describe your issue..." required></textarea>
              </div>
              <div class="mb-3">
                <select id="ticket-priority" class="form-select">
                  <option value="low">Low Priority</option>
                  <option value="medium" selected>Medium Priority</option>
                  <option value="high">High Priority</option>
                </select>
              </div>
              <button type="submit" class="btn btn-primary">Submit Ticket</button>
            </form>
          </div>
        </div>

        <!-- Ticket List -->
        <div id="admin-tickets" style="display: none;">
          <div class="row">
            <!-- Active Tickets Column -->
            <div class="col-lg-8">
              <div class="card">
                <div class="card-header bg-primary text-white">
                  <h5 class="mb-0">
                    <i class="fas fa-exclamation-circle"></i> Active Tickets 
                    <span id="active-count" class="badge bg-light text-dark">0</span>
                  </h5>
                </div>
                <div class="card-body">
                  <div id="active-tickets-list">
                    <!-- Active tickets will be loaded here -->
                  </div>
                </div>
              </div>
            </div>
            
            <!-- Closed Tickets Column -->
            <div class="col-lg-4">
              <div class="card">
                <div class="card-header bg-success text-white">
                  <h5 class="mb-0">
                    <i class="fas fa-check-circle"></i> Closed Tickets 
                    <span id="closed-count" class="badge bg-light text-dark">0</span>
                  </h5>
                </div>
                <div class="card-body closed-tickets-column">
                  <div id="closed-tickets-list">
                    <!-- Closed tickets will be loaded here -->
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- User Tickets (single column for regular users) -->
        <div id="user-tickets" class="card">
          <div class="card-body">
            <h4>Your Tickets</h4>
            <div id="user-tickets-list">
              <!-- User tickets will be loaded here -->
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</main>

<!-- Create Ticket Modal (Keep only this one) -->
<div class="modal fade" id="createTicketModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Create New Support Ticket</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="create-ticket-form">
                    <div class="mb-3">
                        <label for="new-ticket-title" class="form-label">Title *</label>
                        <input type="text" class="form-control" id="new-ticket-title" required placeholder="Brief description of your issue">
                    </div>
                    <div class="mb-3">
                        <label for="new-ticket-description" class="form-label">Description *</label>
                        <textarea class="form-control" id="new-ticket-description" rows="4" required placeholder="Please describe your issue in detail..."></textarea>
                    </div>
                    <div class="mb-3">
                        <label for="new-ticket-priority" class="form-label">Priority</label>
                        <select class="form-control" id="new-ticket-priority">
                            <option value="low">Low</option>
                            <option value="medium" selected>Medium</option>
                            <option value="high">High</option>
                        </select>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" onclick="createTicket()">Create Ticket</button>
            </div>
        </div>
    </div>
</div>

<script>
const API_BASE = 'https://api.multigrounds.org:10065/api';
let currentUser = null;

document.addEventListener('DOMContentLoaded', async () => {
    // Set up form handlers
    setupFormHandlers();
    
    console.log('Page loaded, checking login status...');
    
    // Check if user is already logged in
    try {
        const response = await fetch(`${API_BASE}/check-login`, {
            credentials: 'include'
        });
        const data = await response.json();
        
        console.log('Login check response:', data);
        
        if (data.success && data.logged_in) {
            console.log('User already logged in:', data.user.username);
            currentUser = data.user;
            showTicketSection();
        } else {
            console.log('User not logged in, showing auth forms');
            showAuthForms();
        }
    } catch (error) {
        console.error('Error checking login status:', error);
        showAuthForms();
    }
});

function setupFormHandlers() {
    // Login form
    document.getElementById('login-form').addEventListener('submit', handleLogin);
    
    // Register form  
    document.getElementById('register-form').addEventListener('submit', handleRegister);
    
    // Ticket form
    document.getElementById('ticket-form').addEventListener('submit', handleTicketSubmit);
    
    // Show/hide form buttons
    document.getElementById('show-register').addEventListener('click', () => {
        document.getElementById('login-section').style.display = 'none';
        document.getElementById('register-section').style.display = 'block';
    });
    
    document.getElementById('show-login').addEventListener('click', () => {
        document.getElementById('register-section').style.display = 'none';
        document.getElementById('login-section').style.display = 'block';
    });
    
    // Logout button
    document.getElementById('logout-btn').addEventListener('click', logout);
}

function showAuthForms() {
    document.getElementById('login-section').style.display = 'block';
    document.getElementById('register-section').style.display = 'none';
    document.getElementById('ticket-section').style.display = 'none';
}

function showTicketSection() {
    document.getElementById('login-section').style.display = 'none';
    document.getElementById('register-section').style.display = 'none';
    document.getElementById('ticket-section').style.display = 'block';
    
    // Show admin sections if user is admin
    if (currentUser && currentUser.is_admin) {
        document.getElementById('admin-badge').style.display = 'inline';
        document.getElementById('admin-tickets').style.display = 'block';
        document.getElementById('user-tickets').style.display = 'none';
    } else {
        document.getElementById('admin-tickets').style.display = 'none';
        document.getElementById('user-tickets').style.display = 'block';
    }
    
    loadTickets();
}

async function handleLogin(event) {
    event.preventDefault();
    const username = document.getElementById('login-username').value.trim();
    const password = document.getElementById('login-password').value;
    
    if (!username || !password) {
        alert('Please enter both username and password');
        return;
    }
    
    try {
        const response = await fetch(`${API_BASE}/login`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            credentials: 'include',
            body: JSON.stringify({ username, password })
        });
        
        const data = await response.json();
        if (data.success) {
            currentUser = {
                username: data.username,
                is_admin: data.is_admin
            };
            
            alert('Login successful!');
            showTicketSection();
        } else {
            alert(data.message);
        }
    } catch (error) {
        console.error('Login error:', error);
        alert('Login failed. Please try again.');
    }
}

async function handleRegister(event) {
    event.preventDefault();
    const username = document.getElementById('reg-username').value.trim();
    const email = document.getElementById('reg-email').value.trim();
    const password = document.getElementById('reg-password').value;
    
    if (!username || !email || !password) {
        alert('Please fill in all fields');
        return;
    }
    
    try {
        const response = await fetch(`${API_BASE}/register`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            credentials: 'include',
            body: JSON.stringify({ username, email, password })
        });
        
        const data = await response.json();
        alert(data.message);
        
        if (data.success) {
            event.target.reset();
        }
    } catch (error) {
        console.error('Registration error:', error);
        alert('Registration failed. Please try again.');
    }
}

async function handleTicketSubmit(event) {
    event.preventDefault();
    const title = document.getElementById('ticket-title').value.trim();
    const description = document.getElementById('ticket-description').value.trim();
    const priority = document.getElementById('ticket-priority').value;
    
    if (!title || !description) {
        alert('Please fill in all required fields');
        return;
    }
    
    try {
        const response = await fetch(`${API_BASE}/tickets`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            credentials: 'include',
            body: JSON.stringify({ title, description, priority })
        });
        
        const data = await response.json();
        if (data.success) {
            alert('Ticket created successfully!');
            event.target.reset();
            loadTickets();
        } else {
            alert('Error: ' + data.message);
        }
    } catch (error) {
        console.error('Error creating ticket:', error);
        alert('Error creating ticket. Please try again.');
    }
}

async function loadTickets() {
    try {
        const response = await fetch(`${API_BASE}/tickets`, {
            credentials: 'include'
        });
        const data = await response.json();
        
        if (data.success) {
            displayTickets(data.tickets);
        } else {
            console.error('Failed to load tickets:', data.message);
        }
    } catch (error) {
        console.error('Error loading tickets:', error);
    }
}

function displayTickets(tickets) {
    if (currentUser && currentUser.is_admin) {
        displayAdminTickets(tickets);
    } else {
        displayUserTickets(tickets.user || []);
    }
}

function displayAdminTickets(tickets) {
    const activeList = document.getElementById('active-tickets-list');
    const closedList = document.getElementById('closed-tickets-list');
    const activeCount = document.getElementById('active-count');
    const closedCount = document.getElementById('closed-count');
    
    const activeTickets = tickets.open || [];
    const closedTickets = tickets.closed || [];
    
    activeCount.textContent = activeTickets.length;
    closedCount.textContent = closedTickets.length;
    
    // Display active tickets
    if (activeTickets.length === 0) {
        activeList.innerHTML = '<p class="text-muted">No active tickets</p>';
    } else {
        activeList.innerHTML = activeTickets.map(ticket => createTicketHTML(ticket)).join('');
    }
    
    // Display closed tickets
    if (closedTickets.length === 0) {
        closedList.innerHTML = '<p class="text-muted">No closed tickets</p>';
    } else {
        closedList.innerHTML = closedTickets.map(ticket => createTicketHTML(ticket, true)).join('');
    }
}

function displayUserTickets(tickets) {
    const userList = document.getElementById('user-tickets-list');
    
    if (tickets.length === 0) {
        userList.innerHTML = `
            <div class="text-center py-5">
                <i class="fas fa-ticket-alt fa-3x text-muted mb-3"></i>
                <h5 class="text-muted">No tickets yet</h5>
                <p class="text-muted">Submit your first support ticket using the form above.</p>
            </div>
        `;
    } else {
        userList.innerHTML = tickets.map(ticket => createTicketHTML(ticket)).join('');
    }
}

function createTicketHTML(ticket, isCompact = false) {
    const priorityColor = ticket.priority === 'high' ? 'danger' : ticket.priority === 'medium' ? 'warning' : 'secondary';
    const statusColor = ticket.status === 'open' ? 'success' : ticket.status === 'closed' ? 'secondary' : 'primary';
    
    return `
        <div class="card mb-3 ticket-priority-${ticket.priority}">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h6 class="mb-0">${ticket.title}</h6>
                <div>
                    <span class="badge bg-${priorityColor} me-2">${ticket.priority}</span>
                    <span class="badge bg-${statusColor}">${ticket.status}</span>
                </div>
            </div>
            <div class="card-body">
                ${isCompact ? '' : `<p class="mb-2">${ticket.description}</p>`}
                <small class="text-muted">
                    Created: ${new Date(ticket.created_at).toLocaleDateString()}
                    ${currentUser?.is_admin ? ` | By: ${ticket.username}` : ''}
                </small>
                
                ${ticket.comments && ticket.comments.length > 0 ? `
                    <div class="mt-3">
                        <h6>Comments:</h6>
                        ${ticket.comments.map(comment => `
                            <div class="border-start ps-3 mb-2 ${comment.is_admin_reply ? 'border-primary' : 'border-secondary'}">
                                <strong>${comment.username}${comment.is_admin_reply ? ' (Admin)' : ''}:</strong>
                                <p class="mb-1">${comment.content}</p>
                                <small class="text-muted">${new Date(comment.created_at).toLocaleDateString()}</small>
                            </div>
                        `).join('')}
                    </div>
                ` : ''}
            </div>
        </div>
    `;
}

// Modal functions (keeping for compatibility)
function showCreateTicketModal() {
    const modal = new bootstrap.Modal(document.getElementById('createTicketModal'));
    modal.show();
}

function createTicket() {
    const title = document.getElementById('new-ticket-title').value.trim();
    const description = document.getElementById('new-ticket-description').value.trim();
    const priority = document.getElementById('new-ticket-priority').value;
    
    if (!title || !description) {
        alert('Please fill in all required fields');
        return;
    }
    
    fetch(`${API_BASE}/tickets`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        credentials: 'include',
        body: JSON.stringify({ title, description, priority })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            alert('Ticket created successfully!');
            const modal = bootstrap.Modal.getInstance(document.getElementById('createTicketModal'));
            modal.hide();
            loadTickets();
            document.getElementById('create-ticket-form').reset();
        } else {
            alert('Error: ' + data.message);
        }
    })
    .catch(error => {
        console.error('Error creating ticket:', error);
        alert('Error creating ticket. Please try again.');
    });
}

async function logout() {
    try {
        const response = await fetch(`${API_BASE}/logout`, {
            method: 'POST',
            credentials: 'include'
        });
        
        if (response.ok) {
            currentUser = null;
            alert('You have been logged out.');
            showAuthForms();
        }
    } catch (error) {
        console.error('Logout error:', error);
    }
}
</script>

<!-- Load Bootstrap JS -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

<footer class="footer">
    <p><strong>Contact me:</strong> davemcblame@multigrounds.org</p>
    <span class="version"></span>
</footer>

<script>
async function loadVersion() {
    const vars = await fetch("/globaldata.json")
        .then(r => r.json())
        .catch(e => console.error("Error fetching file", e));

    let versionElements = document.querySelectorAll(".version");
    for (const versionElement of versionElements) {
        versionElement.innerText = vars.version ?? "Not found";
    }
}

loadVersion();
</script>

</body>
</html>